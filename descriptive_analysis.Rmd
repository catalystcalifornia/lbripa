---
title: "Long Beach RIPA Analysis: Frequency counts of LB RIPA Data(2019)"
subtitle: "Descriptive Analysis 2019"
author: "Catalyst California"
date: "11/29/2022"
output:
  html_document:
    number_sections: no
    toc: yes
    toc_depth: 1
    toc_float:
      collapsed: true
      smooth_scroll: true
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(comment=FALSE, message=FALSE, warning=FALSE, echo = FALSE)
```




```{r}
library(tidyverse)
library(RPostgreSQL)
library(tidyverse)
library(lubridate)
library(formattable)
library(flextable)

# Load PostgreSQL driver
source("W:\\RDA Team\\R\\credentials_source.R")
conn <- connect_to_db("eci_lb_ripa")


df <- dbGetQuery(conn, "SELECT * FROM data.ripa_policestop_lb_2019")

#add function that better fits the tables to the page    
    FitFlextableToPage <- function(ft, pgwidth = 6.5){

  ft_out <- ft %>% autofit()

  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))
  return(ft_out)
    }

```



# 1) Stop Duration by Response to Calls for Service

```{r}
df$stop_duration <- as.double(df$stop_duration) # make double
df %>% filter(person_id == "1") %>% group_by(stop_in_response_to_cfs) %>%  summarize(count = n(),
            'Average Stop Time(Mins)' = mean(stop_duration, na.rm = FALSE),
            'Median Stop Time (Mins)'=   median(stop_duration,na.rm = FALSE),
             'Min Stop Time (Mins)'=min(stop_duration,na.rm = FALSE),
            'Max Stop Time (Mins)'=max(stop_duration,na.rm = FALSE),
             'Total Time (Mins)'= sum(stop_duration)) %>%
  mutate(Percent  = round((count/sum(count))*100,1)) %>% 
      
 rename('Service Call'= stop_in_response_to_cfs, 'Count of Stops' = count) %>%
  select('Service Call',  'Count of Stops', Percent, everything())  %>% 
 
#create and style flextable

  flextable() %>% 
colformat_double(j = c("Average Stop Time(Mins)"), digits = 1)%>% 
  set_caption('Stop Counts and Time Stats by Response to Service Call') %>% 
  theme_vanilla() %>%
    width(j=8,.5,unit="in") %>%
  FitFlextableToPage() %>%        
  width(j=2,.58,unit="in") %>%
  width(j=8,.75,unit="in")

            
```

*LBPD officers are spending more total time on officer-initiated stops than requests for service. However, on average, LBPD officers are spending more time on service calls than officer-initiated stops.*

## Officer-initiated Stop Counts and Time Stats by Reason

```{r}
df$stop_duration <- as.double(df$stop_duration) # make double
df %>% filter(stop_in_response_to_cfs == "No" & person_id == "1") %>% group_by(all_reasons_for_stop) %>%  summarize(count = n(),
            'Average Stop Time(Mins)' = mean(stop_duration, na.rm = FALSE),
            'Median Stop Time (Mins)'=   median(stop_duration,na.rm = FALSE),
             'Min Stop Time (Mins)'=min(stop_duration,na.rm = FALSE),
            'Max Stop Time (Mins)'=max(stop_duration,na.rm = FALSE),
             'Total Time (Mins)'= sum(stop_duration)) %>%ungroup %>% mutate(Percent  = round((count/sum(count))*100,1)) %>% arrange(desc(Percent)) %>%
      
 rename('Count of Stops' = count, Reason = all_reasons_for_stop) %>%
  select(Reason , 'Count of Stops', Percent, everything())  %>% 
 
#create and style flextable

  flextable() %>% 
colformat_double(j = c("Average Stop Time(Mins)"), digits = 1)%>% 
  set_caption('Officer-initiated Stop Counts and Time Stats by Reason') %>% 
  theme_vanilla() %>%
    width(j=8,.5,unit="in") %>%
  FitFlextableToPage() %>%        
  width(j=2,.58,unit="in") %>%
  width(j=8,.75,unit="in")
```


*The top 2 reasons for officer-initiated stops are traffic violation and reasonable suspicion.*

# 2) Calls for Service by Race


```{r}
df %>% group_by(stop_in_response_to_cfs, perceived_race_simplified) %>%  summarize(count = n()) %>% group_by(perceived_race_simplified) %>% mutate(Percent  = round((count/sum(count))*100,2)) %>% arrange(perceived_race_simplified) %>%
      
 rename('Service Call'= stop_in_response_to_cfs, 'Count of Stops' = count, Race = perceived_race_simplified) %>%
  select('Service Call',  Race, 'Count of Stops', Percent, everything())  %>% 
 
#create and style flextable

  flextable() %>% 
  set_caption('Calls for Service by Race') %>% 
  theme_vanilla() %>%
    width(j=4,.5,unit="in") %>%
  FitFlextableToPage() %>%        
  width(j=2,.58,unit="in") %>%
  width(j=4,.75,unit="in")

```



# 3) Number of Unique Stops (stop id) for Officer-initiated Stops

```{r}
# df %>% filter(stop_in_response_to_cfs == "No") %>% summarize(distinct = n_distinct(stop_id))
```


```{r}
df %>% filter(person_id == "1" & stop_in_response_to_cfs == "No") %>% nrow()
```



*There are 32,191 unique officer-initiated stops.*

# 4) Number of People Stopped by Officers for Officer-initiated Stops


```{r}
df %>% filter(stop_in_response_to_cfs == "No") %>% nrow()

```

*35,195 total number of people were stopped by LBPD in 2019 for officer-initiated reasons.* 


# 5) Perceived Age Stats for Officer-initiated Stops

```{r}
df$perceived_age <- as.double(df$perceived_age)

df %>% filter(stop_in_response_to_cfs == "No") %>% summarize('Average Age'=mean(perceived_age,na.rm = FALSE),
            'Median Age'=median(perceived_age,na.rm = FALSE),
            'Min Age'=min(perceived_age,na.rm = FALSE),
            'Max Age'=max(perceived_age,na.rm = FALSE)) %>%  flextable() 
```
*The average age of a civilian stopped by LBPD for officer-initiated reasons is ~34-35 years. The median age is 30 years. The age of a civilian stopped by LBPD ranges from 1-120 years.* 


# 6) Perceived Races for Officer-initiated Stops


```{r}
df %>% filter(stop_in_response_to_cfs == "No") %>% group_by(perceived_race_simplified) %>% summarize(count = n()) %>% arrange(desc(count)) %>% mutate(Percent  = round((count/sum(count))*100,1)) %>% rename(Race = perceived_race_simplified) %>% flextable() %>% 
colformat_double(j = c("count"), digits = 1)%>% 
  set_caption('Stop Counts by Race') %>% 
  theme_vanilla() %>%
    width(j=3,.5,unit="in") %>%
  FitFlextableToPage() %>%        
  width(j=2,.58,unit="in")
```

*Hispanic/Latinx and Black Californians make up the vast majority of people stopped by LBPD for officer-initiated stops.*


# 7) Actions Taken for Officer-initiated Stops



```{r}
df %>% filter(stop_in_response_to_cfs == "No") %>% group_by(actions_taken) %>% summarize(count = n()) %>% arrange(desc(count))  %>% mutate(Percent  = round((count/sum(count))*100,2)) %>% rename('Actions Taken' = actions_taken)  %>% slice(1:100) %>%
  
  flextable() %>% 
colformat_double(j = c("count"), digits = 1) %>%  
  set_caption(' Top 100 Actions Taken') %>% 
  theme_vanilla() %>%
    width(j=3,.5,unit="in") %>%
  FitFlextableToPage() %>%        
  width(j=2,.58,unit="in")
```

*There are 679 unique observations for actions taken from officer-initiated stops. 72.5% of the observations result in no action taken while 27.5% of observations result in some action, usually curbside detention combined with another action taken.*






# 8) Reasons for Officer-initiated Stops by Race

```{r}
df %>% filter(stop_in_response_to_cfs == "No") %>% group_by(all_reasons_for_stop, perceived_race_simplified) %>% summarize(count = n()) %>% arrange(desc(count))  %>% group_by(perceived_race_simplified) %>% mutate(Percent  = round((count/sum(count))*100,2)) %>% arrange(perceived_race_simplified) %>% rename('Reasons for Stop' = all_reasons_for_stop, 'Race' = perceived_race_simplified)  %>% flextable() %>% 
colformat_double(j = c("count"), digits = 1)%>% 
  set_caption('Reason For Stop Frequency by Race') %>% 
  theme_vanilla() %>%
    width(j=3,.5,unit="in") %>%
  FitFlextableToPage() %>%        
  width(j=2,.58,unit="in")
```

*The vast majority of reason the LBPD stopped a civilian was due to traffic violation(73.83%), with the second most common reason being Reasonable Suspicion(21.7%).*



# 9) Results of Officer-initiated Stops

```{r}
df %>% filter(stop_in_response_to_cfs == "No") %>% group_by(result_of_stop_simplified) %>% summarize(count = n())  %>% arrange(desc(count)) %>% mutate(Percent  = round((count/sum(count))*100,2)) %>% rename('Result of Stop' = result_of_stop_simplified) %>% flextable() %>% 
colformat_double(j = c("count"), digits = 1)%>% 
  set_caption('Result For Stop Frequency') %>% 
  theme_vanilla() %>%
    width(j=3,.5,unit="in") %>%
  FitFlextableToPage() %>%        
  width(j=2,.58,unit="in")#
```

*The vast majority of officer-initiated stops result in a citation for infraction, followed by a verbal/written warning by an LBPD officer and no action.*




## No Action by Race 

```{r}
df %>% filter(stop_in_response_to_cfs == "No" & result_of_stop_simplified == "No Action") %>% group_by(perceived_race_simplified) %>% summarize(count = n())  %>% arrange(desc(count)) %>% mutate(Percent  = round((count/sum(count))*100,2)) %>% rename('Race' = perceived_race_simplified)  %>% flextable() %>% 
colformat_double(j = c("count"), digits = 1)%>% 
  set_caption('No Action Result by Race') %>% 
  theme_vanilla() %>%
    width(j=3,.5,unit="in") %>%
  FitFlextableToPage() %>%        
  width(j=2,.58,unit="in")
```

*A large portion of LBPD officer-initiated stops (67%) result in no action for Hispanic/Latinx and African Americans.*


# 10) Time of Day/Month

```{r}
df <- df %>% mutate(stop_month = month(ymd(stop_date)))
df %>% group_by(stop_month,stop_in_response_to_cfs) %>% summarize(Stops = n()) %>% rename(Month = stop_month) %>% ggplot(aes(x = Month, y = Stops)) + 
geom_line(aes(colour=stop_in_response_to_cfs)) + theme_minimal() + labs(x="Month", y="Stops", title="Total LBPD stops by Month  (2019)") + scale_x_continuous(breaks = seq(1, 12, by = 1)) + theme(plot.title = element_text(hjust=0.5, size=20, face="bold")) + guides(colour=guide_legend(title="Stop in response to Call for Service"))

```

*The number of LBPD officer-initiated and calls for service stops in 2019 peaked in January and slowly decreased overtime.*


```{r}
df$stop_time_new <- format(strptime(df$stop_time, format='%H:%M:%S'), '%I:%M:%S %p')
df %>% select(stop_time, stop_in_response_to_cfs) %>% mutate(stop_hour = hour(hms(stop_time))) %>% rename(Hour = stop_hour) %>% group_by(Hour, stop_in_response_to_cfs) %>% summarize(Stops = n()) %>% ggplot(aes(x = Hour, y = Stops)) + 
geom_line(aes(colour=stop_in_response_to_cfs)) + theme_minimal() + labs(x="Time(24 hour format)", y="Stops", title="Total LBPD stops by Hour (2019)") + scale_x_continuous(breaks = seq(0, 24, by = 1)) + theme(plot.title = element_text(hjust=0.5, size=20, face="bold")) + guides(colour=guide_legend(title="Stop in response to Call for Service"))

  
```

*The vast majority of stops occur between the hours of 5:00-6:00 P.M, followed by 10:00 a.m, 4:00 P.M., and 8:00 A.M. The least amount of stops occur between the hours of 1:00 A.M.-5:00 A.M.*

# 11) Contraband/Hit Rates
<!-- Whether contraband was found by race out of everyone that was searched (# of officer-initiated stops where person or property searched and what % of those was contraband found) -->

```{r}
# create a categorical column for if contraband was found
df <- df %>% mutate(
was_contraband_found = ifelse(number_of_contrabands_evidences>0, "yes","no")
)



#filter for officer intiated stops & for stops that were searched
df %>% filter(stop_in_response_to_cfs == "No" & 	
was_person_or_property_searched == "Yes") %>% 
  # group by race and contraband categorical
  group_by(perceived_race_simplified, was_contraband_found) %>%
  summarize(count = n())  %>% group_by(perceived_race_simplified) %>% mutate(Percent  = round((count/sum(count))*100,2)) %>% arrange(perceived_race_simplified) %>% rename('Contraband Found' = was_contraband_found, 'Race' = perceived_race_simplified)  %>% flextable() %>% 
colformat_double(j = c("count"), digits = 1)%>% 
  set_caption('Contraband Found out of Total Searches by Race') %>% 
  theme_vanilla() %>%
    width(j=3,.5,unit="in") %>%
  FitFlextableToPage() %>%        
  width(j=2,.58,unit="in")
```
