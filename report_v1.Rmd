---
title: "Disparities in LBPD's Practices"
subtitle: "DRAFT"
author: "Catalyst California"
output:
  html_document:
    code_folding: hide
    toc: yes
    toc_depth: 2
    toc_float: yes
date: "`r format(Sys.time(), '%d %B, %Y')`"
---
  
  
```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)
#### Load libraries ####
library(usethis)
library(highcharter)
library(tidyverse)
library(sf)
library(leaflet)
library(sp)
library(htmltools) # for html escape
library(magrittr)
#library(leaflegend) # customize legends to change shapes:: commenting out because not needed for high injury network maps for now


library(htmlwidgets)


#### Add database connection ####
source("W:\\RDA Team\\R\\credentials_source.R")

con <- connect_to_db("eci_lb_ripa")

### Import Data ###
report_stoprates_race_person <- dbGetQuery(con, "SELECT * FROM data.report_stoprates_race_person") 
report_stoprates_cd_race_person <- dbGetQuery(con, "SELECT * FROM data.report_stoprates_cd_race_person") 
report_hitrates_race_person <- dbGetQuery(con, "SELECT * FROM data.report_hitrates_race_person") 
council_district <- st_read(con, query = "SELECT * FROM data.colb_council_districts_place_2022")
high_injury_motor_corridors_line_sf <- st_read(con, query = "SELECT * FROM data.high_injury_motor_corridors_spatial") %>% st_as_sf()
high_injury_motor_intersections_spdf <- st_read(con, query = "SELECT * FROM data.high_injury_motor_intersections_spatial")
high_injury_ped_corridors_line_sf  <- st_read(con, query = "SELECT * FROM data.high_injury_ped_corridors_spatial")  %>% st_as_sf()
high_injury_ped_intersections_spdf <- st_read(con, query = "SELECT * FROM data.high_injury_ped_intersections_spatial")
report_timespent_officerinitiated_cd_stop <- st_read(con, query = "SELECT * FROM data.report_timespent_officerinitiated_cd_stop")
report_traffic_stoprates_cd_race_person <- dbGetQuery(con, "SELECT * FROM data.report_traffic_stoprates_cd_race_person") 
population_race_cd <-  dbGetQuery(con, "SELECT * FROM data.population_race_cd") 
## Source the Chart Template

source("W:/Project/ECI/LB RIPA/R/chart_functions.R")


```

> **Through-Line: LBPD spends more time and money racially profiling folks in North and Central (these two geographic locations are there by example, they could also be District 8 & 9) Long Beach than they spend actually protecting the community. Most of this profiling is conducted via traffic stops. These stops do not make the community safer, and they mean the LBPD spends less time responding to calls for service.**

# The Context

Communities of color in Long Beach have historically been subjected to over-policing and racial profiling by law enforcement. This trend continues today where people of color are more likely to be stopped by LBPD for minor reasons to profile and harass them.

Examining data from the Racial & Identity Profiling Act (RIPA), we find that LBPD spends most of their time on stopping people for purported traffic reasons. These stops do not make communities safer. Instead, they subject low-income communities of Long Beach to undue contact with the police. These are the same communities that have historically had the fewest resources for other services in the city. The inequities in and ineffectiveness of these practices demand investments in alternatives.

# The Data

## LBPD spends most of their time racially profiling communities

We find that LBPD spends more time on stops made during their patrol time (referred to as officer-initiated stops) than stops made in response to calls from the community. The type of stops and results of these stops show evidence of racial profiling.

### Most time is spent on officer-initiated stops not on  responding to concerns from the community.   

Nearly 80% of time officers spent on stops are spent on officer-initiated stops. This translates to just 1 in 5 hours spent on responding to calls for service, or concerns from the community. 


```{r, echo=FALSE}
#### JZ ####

##### Chart - % time spent on cfs vs. officer-initiated stops #####

#read in table
df<-dbGetQuery(con, "SELECT * FROM report_timespent_cfs_stop")

# create donut chart

df %>%
  hchart(
    "pie", hcaes(x = label, y = hours_rate_cap),
    name = "",
    tooltip = list(headerFormat="", pointFormat = "<b>{point.hours_rate_cap:.1f}%</b> of hours are spent on <b>{point.label}</b>, or a total of {point.hours_count_cap:,.1f} hours"),
     innerSize="65%",
     center = c(50, 50), 
    )%>% 
  hc_title(text = "Three in four hours are spent on officer-initiated stops not calls for service",
 align="left")%>%
   hc_subtitle(text = "Percent of hours spent on calls for service versus officer-initiated stops",
                     align="left") %>%
  hc_caption(
    text = paste0(sourcenote))%>%
  hc_plotOptions(
    innersize="50%", 
    startAngle=90, 
    endAngle=90,
    center=list('50%', '75%'),
    size='120%')%>%
hc_add_theme(cc_theme)%>%
  hc_exporting(
    enabled = TRUE, sourceWidth=900, sourceHeight=600, 
    chartOptions=list(plotOptions=list(series=list(dataLabels=list(enabled=TRUE, format='{point.hours_rate_cap:.1f}%')))),
    filename = paste0("Percent of hours spent on calls for service versus officer-initiated stops","_Catalyst California, catalystcalifornia.org, 2023.")
  )

```

### These stops disproportionately impact people of color across the city.

People of color are more likely to be impacted by this high occurrence of officer-initiated stops. As a part of RIPA data collection, officers are required to report the race of the person they stopped, based on the officer's perception. The data show LBPD officers stop Black, Native Hawaiian or Pacific Islander, and Middle Eastern or South African peoples in Long Beach at the highest rates. In 2019, LBPD officers stopped 169 Black people for every one thousand Black people in Long Beach. And while White people make up a much larger share of the Long Beach population, more Black people are stopped by LBPD than White people.

```{r, echo=FALSE}
#### DS ####

##### Chart - stop rates per 1K by race for LB #####
#### DS ####

##### Chart - stop rates per 1K by race for LB #####
# add a comma to stop count

# Apply Chart

report_stoprates_race_person<-report_stoprates_race_person%>%filter(race!="total")

fx_barbubblechart(

  db=report_stoprates_race_person, #name of dataframe

  order_var=report_stoprates_race_person$stop_rate_per1k, #variable you're sorting by

  x='race_label_short', # x or independent variables

  y='stop_rate_per1k', # y or dependent variable

  z='stop_count',

  top_finding=paste0("LBPD stopped Black, NHPI, and MESA people at higher rates than other community members."), # this is the top finding from the chart that gets used like a title

  chart_title= paste0("Number of Officer-initiated Stops per 1K of Same Population by Race and Ethnicity"), # this is the more standard chart title that gets used as a subtitle

  tooltip_text="For every 1K <b>{point.race_label_long:.1f}</b> people in Long Beach, LBPD stopped <b>{point.stop_rate_per1k:.1f}</b> people perceived as <b>{point.race_label_long:.1f}</b>, a total of <b>{point.stop_count:,0f}</b> people.", # customize your tooltip as a statement, calling out rate and count


  chart_caption = paste0(racenote,"<br>", sourcenote, "<br><br><br>"), # if necessary add a method note between the racenote and sourcenote with a line break, use racenote if graph includes data by race, and always use sourcenote. Each of these are standard objects across all charts

  yaxis_label = "''", #format for your y axis labels
   export_data_label=list(pointFormat='{point.stop_rate_per1k:.1f} per 1K')
)
```

### Stops are made based on racial profiling not risk for crime {.tabset}

Officers are required to report the reason why they stopped a person and the result of that stop, e.g. whether a person received a citation, was arrested, or no consequence or action was necessary. We analyze the time spent on officer-initiated stops by stop reason and then by stop result to determine if officers are making stops that help prevent a serious threat to community safety. Stops are made mainly for minor traffic reasons that are resolved with a citation or warning, or no action at all. Then, we narrow in on traffic stops that resulted in no action to see if traffic stops of people of color are more likely to result in some consequence for safety. In the end, these stops show more evidence of racial profiling than protecting the safety of communities. While LBPD is more likely to stop Black people and other people of color, a sizable share of these stops are traffic stops have no or minor implications for community safety. In 2019, over 1 in 5 traffic stops of Black people resulted in no action.

#### Time spent on stops by reason

```{r, echo=FALSE}

###JZ###

#  Chart - % time spent on stops by stop reason:
# ideally these charts should be on a carousel (https://www.r-bloggers.com/2017/04/slickr/)

#read in table

df<-dbGetQuery(con, "SELECT * FROM report_timespent_reason_stop")%>%
  arrange(-hours_rate)

#####  Lollipop #####

# apply lollypop chart function

# Apply Chart 

fx_lollichart(
  df, #name of dataframe
  order_var=df$hours_rate, #variable you're sorting by
  x='stop_reason_short', # x or independent variables
  y='hours_rate', # y or dependent variable

  top_finding=paste0("Officers spend most of their time on traffic stops and stops for reasonable suspicion"), # this is the top finding from the chart that gets used like a title

  chart_title= paste0("Hours spent on stops by stop reason"), # this is the more standard chart title that gets used as a subtitle

  tooltip_text="<b>{point.hours_rate:.1f}%</b> of hours are spent on <b>{point.stop_reason_short}</b>, or a total of {point.hours_count:,.1f} hours", 

  chart_caption = paste0(sourcenote), 
  yaxis_label = "'%'", #format for your y axis labels
  export_data_label=list(pointFormat='{point.hours_rate:.1f}% of hours spent'))


```

#### Time spent on traffic stops by result

```{r, echo=FALSE}

### JZ ###

#read in table

df<-dbGetQuery(con, "SELECT * FROM report_timespent_result_stop ")


# for now filter just traffic and reasonable suspicion as separate dfs

df_traffic<-df%>%
  filter(grepl('Traffic Violation',stop_reason_short))%>%
  arrange(-hours_rate)
   
  
  # mutate(hours_rate= round(hours_rate, 0))

col <-c(meteorite, lavender, orange, peridot, "#177FEB", "#733256", "#9B9A9A", "#211447",
        "#FF9E0D")


#### Item Chart 1: Traffic Stops + Results -rate of hours (/100) ####

hc<-hchart(
  df_traffic,
  "item",
  rows=8,
  tooltip = list(headerFormat="", pointFormat = "Out of 100 hours, LBPD spent <b>{point.hours_rate:.1f}</b> hours on traffic stops that resulted in <b>{point.stop_result_short}</b>"),
  hcaes(
    name = stop_result_short,
    y = hours_rate,
    label = stop_result_short,
    color = col
  ),
  name = "Total Hours",
  showInLegend = TRUE) %>%
  
  hc_title(text = "The majority of hours spent on traffic stops result in citations, warnings, or no action", 
 align="left" )%>%
  
  hc_caption(
    text = paste0(sourcenote)) %>% 
  hc_add_theme(cc_theme)%>%
  hc_exporting(
    enabled = TRUE, sourceWidth=900, sourceHeight=600, 
    chartOptions=list(plotOptions=list(series=list(dataLabels=list(enabled=TRUE, format=paste0(list(pointFormat='{point.hours_rate:.1f}')))))),
    filename = paste0("The majority of hours spent on traffic stops result in citations, warnings, or no action","_Catalyst California, catalystcalifornia.org, 2023.")
  )%>%
  
  hc_legend(title=list(text='<span style="font-size: 12px; color: #000000; font-weight: bold">Single dot represents 1 hour out of 100 hours</span><br/><span style="font-size: 10px; color: #666; font-style: italic">Click to hide</span>'),
            enable = TRUE, 
            labelFormat = '{name} <span style="opacity: 0.4">{hours_rate:.1f}</span>')

# add in margins so the graph isn't cut off

hc %>%
  hc_chart(
    marginRight = 100,
    marginLeft=100
  )



```




#### Rate of traffic stops by result and race

```{r, echo=FALSE}

### JZ ###

# Read in table

df<-dbGetQuery(con, "SELECT * FROM report_stoprates_result_race_person")

# filter for traffic

traffic<-df%>%
  filter(grepl('Traffic Violation',reason))%>%
  filter(grepl('No Action',result))%>%
  filter(!grepl('Total',race_label_short))%>%
  arrange(desc(stop_denom_rate))

#####  Lollipop #####

# apply lollypop chart function

# Apply Chart 

fx_barbubblechart(

  db=traffic, #name of dataframe

  order_var=traffic$stop_denom_rate, #variable you're sorting by

  x='race_label_short', # x or independent variables

  y='stop_denom_rate', # y or dependent variable

  z='pop_count',

  top_finding=paste0("Multiracial and Black people are most likely to be stopped for minor traffic stops."), # this is the top finding from the chart that gets used like a title

  chart_title= paste0("Percent of traffic stops that resulted in no action by race"), # this is the more standard chart title that gets used as a subtitle

 
  tooltip_text="<b>{point.stop_denom_rate:,.1f}%</b> of stops of <b>{point.race_label_short}</b> people result in No Action, or a total of {point.stop_count:,.1f} stops", # customize your tooltip as a statement, calling out rate and count

  
  chart_caption = paste0(racenote,"<br>", sourcenote, "<br><br><br>"), 
  yaxis_label = "'%'", #format for your y axis labels
  export_data_label=list(pointFormat='{point.stop_denom_rate:.1f}%'))


```

```{r, echo=FALSE}


# # Read in table
# 
# df<-dbGetQuery(con, "SELECT * FROM report_stoprates_result_race_person")
# 
# # filter for traffic
# 
# traffic<-df%>%
#   filter(grepl('Traffic Violation',reason))%>%
#   filter(grepl('No Action|Warning',result))%>%
#   filter(!grepl('Total',race_label_short))
# 
# 
# # set order of grouped bars
# 
# traffic <- within(traffic, result <- factor(result, levels=c("Warning","No Action")))
# 
# # set color levels custom
# 
# color <-  c(meteorite, orange)
# 
# 
# traffic%>%
#   arrange(desc(result))%>%
#   hchart("lollipop", invert = TRUE,
#          hcaes(x=race_label_short,
#                y=stop_pop_rate,
#                group=result),
#          color=color)%>%
#   hc_xAxis( title = list(text = "") ) %>% 
#   
#   hc_yAxis( title = list(text = ""),
#             labels = list(format = "{value}%")) %>%  
#   
#   # title elements
#   hc_title(
#     text = paste0("Black drivers are most likely to be stopped for minor traffic stops"),
#     #margin = 20,
#     align = "left", 
#     style = list(useHTML = TRUE
#     )
#   ) %>% 
#   hc_plotOptions(series=list(connectorWidth=1.2,
#                              marker=list(symbol='circle')))%>%
#   hc_subtitle(
#     text = paste0("Rate of traffic stops that resulted in a warning no action by race"), align="left"
#   ) %>% 
#   hc_caption(
#     text = paste0(racenote,"<br>", sourcenote)
#   ) %>% 
#   hc_add_theme(cc_theme)%>%
#   hc_chart(inverted = T) %>%
#   hc_exporting(
#     enabled = TRUE, sourceWidth=900, sourceHeight=600, 
#     chartOptions=list(plotOptions=list(series=list(dataLabels=list(enabled=TRUE, format=paste0(list(pointFormat='{point.stop_pop_rate:.1f}%')))))),
#     filename = paste0("Rate of traffic stops that resulted in a warning no action by race","_Catalyst California, catalystcalifornia.org, 2023.")
#   )
# 
# 

```

## Low-income communities of color are unjustly targeted with unnecessary stops, perpetuating inequities. 

We map the approximate location of officer-initiated stops by council district, race, and result to see how stops are distributed throughout the city. In 2019, Council Districts 1, 6, and 7 had the highest counts and rates of stops per population. Across Council Districts, people of color experience the highest stop rates. Higher stop rates do not translate to a greater likelihood of stops that are a risk to the community. In Council Districts 8, 9, 1, and 6, a higher share of stops result in no action. These districts have some of the highest rates of people of color in the city. 


### Stops are concentrated in central Long Beach and among people of color across Council Districts. {.tabset .tabset-pills}

Across Council Districts, LBPD stops people of color at the highest rates. Plotting stops by race and council districts, we find a greater density of stops of Black and Latinx people. In 2019, in six out of nine Council Districts, Black people had the highest stop rates. Latinx, MESA, and NHPI people also experience the highest rate of stops in at least one of each Council District.

```{r, echo = FALSE}
#### DS ####
#### Choropleth ( Commented out because we are proceeding with point density)


#### DS ####


##### Map - stop rates or counts by council district #####

####council_district$council_num <- as.character(council_district$council_num) # change council number to character to merge




## make data into wide format;
####df <- report_stoprates_cd_race_person %>% select(council_num, race, pop_count, stop_count, stop_rate) %>%  pivot_wider(
####  names_from = race,
####  names_glue = "{race}_{.value}",
####  values_from = c(pop_count:stop_rate)
####)


## get rate by council number

####council_district_rate <- council_district %>% 
####  left_join(
####    df
####  ) 

## only keep last name of rep
####council_district_rate <- council_district_rate %>% mutate(representat = gsub(".* ", "", representat))


#palette purples
## Total
##pal_total <- colorQuantile("Blues", council_district_rate$total_stop_rate, n = 5)
##total_stop_popup <- paste0((
#  label = paste0(
#    "For every 1K <span style='font-weight: bold;'>Total</span> people in Council District  <span style='font-size: 12px; font-weight: bold;'>",  
#    council_district_rate$council_num, "</span> (Rep. <span style='font-size: 12px; font-weight: bold;'>", council_district_rate$representat,"</span>), LBPD stopped <span #style='font-size: 12px; font-weight: bold;'>",  
#    council_district_rate$total_stop_rate , "</span>  people, a total of <span style='font-size: 12px; font-weight: bold;'> ", scales::comma(council_district_rate$total_stop_count), #"</span> people. ")))




## Latinx
#pal_latinx <- colorQuantile("Blues", council_district_rate$latinx_stop_rate, n = 5)
#latinx_stop_popup <- paste0((
#  label = paste0(
#    "For every 1K <span style='font-weight: bold;'>Latinx</span> people in Council District  <span style='font-size: 12px; font-weight: bold;'>",  
#    council_district_rate$council_num, "</span> (Rep. <span style='font-size: 12px; font-weight: bold;'>", council_district_rate$representat,"</span>), LBPD stopped <span #style='font-size: 12px; font-weight: bold;'>",  
#    council_district_rate$latinx_stop_rate , "</span>  people identified as <span style='font-weight: bold;'>Latinx</span>, a total of <span style='font-size: 12px; font-weight: bold;'> #",  scales::comma(council_district_rate$latinx_stop_count), "</span> people. ")))


## Nh White
#pal_nh_white <- colorQuantile("Blues", council_district_rate$nh_white_stop_rate, n = 5)

#nh_white_stop_popup <- paste0((
#label = paste0(
#    "For every 1K <span style='font-weight: bold;'>White</span> people in Council District  <span style='font-size: 12px; font-weight: bold;'>",  
#    council_district_rate$council_num, "</span> (Rep. <span style='font-size: 12px; font-weight: bold;'>", council_district_rate$representat,"</span>), LBPD stopped <span #style='font-size: 12px; font-weight: bold;'>",  
#    council_district_rate$nh_white_stop_rate , "</span>  people identified as <span style='font-weight: bold;'>White</span>, a total of <span style='font-size: 12px; font-weight: bold;'> #", scales::comma(council_district_rate$nh_white_stop_count), "</span> people. ")))


## Nh Black
#pal_nh_black <- colorQuantile("Blues", council_district_rate$nh_black_stop_rate, n = 5)

#nh_black_stop_popup <- paste0((
#  label = paste0(
#    "For every 1K <span style='font-weight: bold;'>Black</span> people in Council District  <span style='font-size: 12px; font-weight: bold;'>",  
#    council_district_rate$council_num, "</span> (Rep. <span style='font-size: 12px; font-weight: bold;'>", council_district_rate$representat,"</span>), LBPD stopped <span #style='font-size: 12px; font-weight: bold;'>",  
#    council_district_rate$nh_black_stop_rate , "</span>  people identified as <span style='font-weight: bold;'>Black</span>, a total of <span style='font-size: 12px; font-weight: bold;'> #", scales::comma(council_district_rate$nh_black_stop_count), "</span> people. ")))




## Nh Asian
#pal_nh_asian <- colorQuantile("Blues", council_district_rate$nh_asian_stop_rate, n = 5)

#nh_asian_stop_popup <- paste0((
#  label = paste0(
#    "For every 1K <span style='font-weight: bold;'>Asian</span> people in Council District  <span style='font-size: 12px; font-weight: bold;'>",  
#    council_district_rate$council_num, "</span> (Rep. <span style='font-size: 12px; font-weight: bold;'>", council_district_rate$representat,"</span>), LBPD stopped <span #style='font-size: 12px; font-weight: bold;'>",  
#    council_district_rate$nh_asian_stop_rate , "</span>  people identified as <span style='font-weight: bold;'>Asian</span>, a total of <span style='font-size: 12px; font-weight: bold;'> #", scales::comma(council_district_rate$nh_asian_stop_count), "</span> people. ")))


## Nh Two or mor
#pal_nh_twoormor <- colorQuantile("Blues", council_district_rate$nh_twoormor_stop_rate, n = 5)

#nh_twoormor_stop_popup <- paste0((
#  label = paste0(
#    "For every 1K <span style='font-weight: bold;'>Two or More Races</span> people in Council District  <span style='font-size: 12px; font-weight: bold;'>",  
#    council_district_rate$council_num, "</span> (Rep. <span style='font-size: 12px; font-weight: bold;'>", council_district_rate$representat,"</span>), LBPD stopped <span #style='font-size: 12px; font-weight: bold;'>",   
#    council_district_rate$nh_twoormor_stop_rate , "</span>  people identified as <span style='font-weight: bold;'>Two or More Races</span>, a total of <span style='font-size: 12px; #font-weight: bold;'> ", scales::comma(council_district_rate$nh_twoormor_stop_count), "</span> people. ")))


#council_district_rate$aian_stop_rate,

## AIAN
#pal_aian <- colorQuantile("Blues", council_district_rate$aian_stop_rate, n = 5)

#aian_stop_popup <- paste0((
#  label = paste0(
#    "For every 1K <span style='font-weight: bold;'>American Indian and Alaska Native</span> people in Council District  <span style='font-size: 12px; font-weight: bold;'>",  
#    council_district_rate$council_num, "</span> (Rep. <span style='font-size: 12px; font-weight: bold;'>", council_district_rate$representat,"</span>), LBPD stopped <span #style='font-size: 12px; font-weight: bold;'>",  
#    council_district_rate$aian_stop_rate , "</span>  people identified as <span style='font-weight: bold;'>American Indian and Alaska Native</span>, a total of <span style='font-size: #12px; font-weight: bold;'> ", scales::comma(council_district_rate$aian_stop_count), "</span> people. ")))


#council_district_rate$nhpi_stop_rate,
## NHPI
#pal_nhpi <- colorQuantile("Blues", council_district_rate$nhpi_stop_rate, n = 5)

#nhpi_stop_popup <- paste0((
#  label = paste0(
#    "For every 1K <span style='font-weight: bold;'>Native Hawaiian or Pacific Islander</span> people in Council District  <span style='font-size: 12px; font-weight: bold;'>",  
#    council_district_rate$council_num, "</span> (Rep. <span style='font-size: 12px; font-weight: bold;'>", council_district_rate$representat,"</span>), LBPD stopped <span #style='font-size: 12px; font-weight: bold;'>",  
#    council_district_rate$nhpi_stop_rate , "</span>  people identified as <span style='font-weight: bold;'>Native Hawaiian or Pacific Islander</span>, a total of <span style='font-size: #12px; font-weight: bold;'> ", scales::comma(council_district_rate$nhpi_stop_count), "</span> people. ")))



#council_district_rate$mesa_stop_rate,
## MESA

#pal_mesa <- colorQuantile("Blues", council_district_rate$mesa_stop_rate, n = 5)
#mesa_stop_popup <- paste0((
#  label = paste0(
#    "For every 1K <span style='font-weight: bold;'>Middle Eastern or South Asian</span> people in Council District  <span style='font-size: 12px; font-weight: bold;'>",  
#    council_district_rate$council_num, "</span> (Rep. <span style='font-size: 12px; font-weight: bold;'>", council_district_rate$representat,"</span>), LBPD stopped <span #style='font-size: 12px; font-weight: bold;'>",  
#    council_district_rate$mesa_stop_rate , "</span>  people identified as <span style='font-weight: bold;'>Middle Eastern or South Asian</span>, a total of <span style='font-size: 12px; #font-weight: bold;'> ", scales::comma(council_district_rate$mesa_stop_count), "</span> people. ")))






#leaflet(width = "100%", height = "495px") %>%


# add Long beach district layer with stop rates

## Total Choropleth
#  addPolygons(data = council_district_rate, label=~htmlEscape(paste0("Council Number ", council_num)), color = "#444444", group = "Total",  weight = 1, smoothFactor = 0.5,  opacity = #1,fillOpacity = 2, popup = ~paste0(total_stop_popup), fillColor = ~pal_total(total_stop_rate), highlight = highlightOptions(color = "white", weight = 7, bringToFront = TRUE, sendToBack = #FALSE)) %>%


## add legend for Total stop rate
# addLegend(layerId = "Total", position = "bottomleft", group = "Total", pal = pal_total, values = council_district_rate$total_stop_rate, opacity = .5, title = "Officer-Initiated Stop #Rate By Council District Per 1K Total Residents", na.label = NA, labFormat = function(type, cuts, p) {
#    n = length(cuts)
#    paste0(cuts[-n], " &ndash; ", cuts[-1])
#  }) %>%

## Latinx choropleth
#  addPolygons(data = council_district_rate, label=~htmlEscape(paste0("Council Number ", council_num)), color = "#444444", group = "Latinx",  weight = 1, smoothFactor = 0.5,  opacity = 1, #fillOpacity = 2, popup = ~paste0(latinx_stop_popup), fillColor = ~pal_latinx(latinx_stop_rate), highlight = highlightOptions(color = "white", weight = 7, bringToFront = TRUE, sendToBack = # FALSE)) %>%

## add legend for Latinx Stop Rate
#  addLegend(layerId = "Latinx", position = "bottomleft", group = "Latinx", pal = pal_latinx, values = council_district_rate$latinx_stop_rate, opacity = .5, title = "Officer-Initiated Stop #Rate By Council District Per 1K Latinx Residents", na.label = NA, labFormat = function(type, cuts, p) {
#    n = length(cuts)
#    paste0(cuts[-n], " &ndash; ", cuts[-1])
#  }) %>%


## Nh White choropleth
#  addPolygons(data = council_district_rate, label=~htmlEscape(paste0("Council Number ", council_num)), color = "#444444", group = "White",  weight = 1, smoothFactor = 0.5, opacity = 1, #fillOpacity = 2, popup = ~paste0(nh_white_stop_popup), fillColor = ~pal_nh_white(nh_white_stop_rate), highlight = highlightOptions(color = "white", weight = 7, bringToFront = TRUE, #sendToBack = FALSE)) %>%


## add legend for Nh White Stop Rate
# addLegend(layerId = "White", position = "bottomleft", group = "White", pal = pal_nh_white, values = council_district_rate$nh_white_stop_rate, opacity = .5, title = "Officer-Initiated #Stop Rate By Council District Per 1K White Residents", na.label = NA, labFormat = function(type, cuts, p) {
#    n = length(cuts)
#    paste0(cuts[-n], " &ndash; ", cuts[-1])
#  }) %>%


## Nh Black choropleth
#  addPolygons(data = council_district_rate, label=~htmlEscape(paste0("Council Number ", council_num)), color = "#444444", group = "Black",  weight = 1, smoothFactor = 0.5, opacity = 1, #fillOpacity = 2, popup = ~paste0(nh_black_stop_popup), fillColor = ~pal_nh_black(nh_black_stop_rate), highlight = highlightOptions(color = "white", weight = 7, bringToFront = TRUE, #sendToBack = FALSE)) %>%


## add legend for Nh White Stop Rate
# addLegend(layerId = "Black", position = "bottomleft", group = "Black", pal = pal_nh_black, values = council_district_rate$nh_black_stop_rate, opacity = .5, title = "Officer-Initiated #Stop Rate By Council District Per 1K Black Residents", na.label = NA,labFormat = function(type, cuts, p) {
#  n = length(cuts)
#    paste0(cuts[-n], " &ndash; ", cuts[-1])
# }) %>%


## Nh Asian choropleth
#  addPolygons(data = council_district_rate, label=~htmlEscape(paste0("Council Number ", council_num)), color = "#444444", group = "Asian",  weight = 1, smoothFactor = 0.5, opacity = 1, #fillOpacity = 2, popup = ~paste0(nh_asian_stop_popup), fillColor = ~pal_nh_asian(nh_asian_stop_rate), highlight = highlightOptions(color = "white", weight = 7, bringToFront = TRUE, #sendToBack = FALSE)) %>%


## add legend for Nh Asian Stop Rate
#  addLegend(layerId = "Asian", position = "bottomleft", group = "Asian", pal = pal_nh_asian, values = council_district_rate$nh_asian_stop_rate, opacity = .5, title = "Officer-Initiated #Stop Rate By Council District Per 1K Asian Residents", na.label = NA, labFormat = function(type, cuts, p) {
#    n = length(cuts)
#    paste0(cuts[-n], " &ndash; ", cuts[-1])
#  }) %>%


## Nh two_or_more choropleth
#  addPolygons(data = council_district_rate, label=~htmlEscape(paste0("Council Number ", council_num)), color = "#444444", group = "Two or More",  weight = 1, smoothFactor = 0.5, opacity = # 1, fillOpacity = 2, popup = ~paste0(nh_twoormor_stop_popup), fillColor = ~pal_nh_twoormor(nh_twoormor_stop_rate), highlight = highlightOptions(color = "white", weight = 7, bringToFront = # TRUE, sendToBack = FALSE)) %>%


## add legend for Nh two_or_more Stop Rate
#  addLegend(layerId = "Two or More", position = "bottomleft", group = "Two or More", pal = pal_nh_twoormor, values = council_district_rate$nh_twoormor_stop_rate, opacity = .5, title = #"Officer-Initiated Stop Rate By Council District Per 1K Two or More Residents", na.label = NA,labFormat = function(type, cuts, p) {
#    n = length(cuts)
#    paste0(cuts[-n], " &ndash; ", cuts[-1])
#  }) %>%


## AIAN choropleth
# addPolygons(data = council_district_rate, label=~htmlEscape(paste0("Council Number ", council_num)), color = "#444444", group = "AIAN",  weight = 1, smoothFactor = 0.5, opacity = 1, # # fillOpacity = 2, popup = ~paste0(aian_stop_popup), fillColor = ~pal_aian(aian_stop_rate), highlight = highlightOptions(color = "white", weight = 7, bringToFront = TRUE, sendToBack = #FALSE)) %>%


## add legend for AIAN Stop Rate
#  addLegend(layerId = "AIAN", position = "bottomleft", group = "AIAN", pal = pal_aian, values = council_district_rate$aian_stop_rate, opacity = .5, title = "Officer-Initiated Stop Rate By # Council District Per 1K AIAN Residents", na.label = NA,labFormat = function(type, cuts, p) {
#   n = length(cuts)
#    paste0(cuts[-n], " &ndash; ", cuts[-1])
# }) %>%


## MESA choropleth
#  addPolygons(data = council_district_rate, label=~htmlEscape(paste0("Council Number ", council_num)), color = "#444444", group = "AIAN",  weight = 1, smoothFactor = 0.5, opacity = 1, # fillOpacity = 2, popup = ~paste0(aian_stop_popup), fillColor = ~pal_aian(aian_stop_rate), highlight = highlightOptions(color = "white", weight = 7, bringToFront = TRUE, sendToBack = # FALSE)) %>%


## add legend for MESA Stop Rate
#  addLegend(layerId = "AIAN", position = "bottomleft", group = "AIAN", pal = pal_aian, values = council_district_rate$aian_stop_rate, opacity = .5, title = "Officer-Initiated Stop Rate By #Council District Per 1K AIAN Residents", na.label = NA, labFormat = function(type, cuts, p) {
#   n = length(cuts)
#  paste0(cuts[-n], " &ndash; ", cuts[-1])
#  }) %>%

## NHPI choropleth
# addPolygons(data = council_district_rate, label=~htmlEscape(paste0("Council Number ", council_num)), color = "#444444", group = "NHPI",  weight = 1, smoothFactor = 0.5, opacity = 1, fillOpacity = 2, popup = ~paste0(nhpi_stop_popup), fillColor = ~pal_nhpi(nhpi_stop_rate), highlight = highlightOptions(color = "white", weight = 7, bringToFront = TRUE, sendToBack = FALSE)) %>%


## add legend for NHPI Stop Rate
#  addLegend(layerId = "NHPI", position = "bottomleft", group = "NHPI", pal = pal_nhpi, values = council_district_rate$nhpi_stop_rate, opacity = .5, title = "Officer-Initiated Stop Rate By # Council District Per 1K NHPI Residents", na.label = NA,labFormat = function(type, cuts, p) {
#    n = length(cuts)
#    paste0(cuts[-n], " &ndash; ", cuts[-1])
#  }) %>%


## MESA choropleth
#  addPolygons(data = council_district_rate, label=~htmlEscape(paste0("Council Number ", council_num)), color = "#444444", group = "MESA",  weight = 1, smoothFactor = 0.5, opacity = 1, # fillOpacity = 2, popup = ~paste0(mesa_stop_popup), fillColor = ~pal_mesa(mesa_stop_rate), highlight = highlightOptions(color = "white", weight = 7, bringToFront = TRUE, sendToBack = # FALSE)) %>%


## add legend for MESA Stop Rate
#  addLegend(layerId = "MESA", position = "bottomleft", group = "MESA", pal = pal_mesa, values = council_district_rate$mesa_stop_rate, opacity = .5, title = "Officer-Initiated Stop Rate By #Council District Per 1K MESA Residents", na.label = NA, labFormat = function(type, cuts, p) {
#    n = length(cuts)
#    paste0(cuts[-n], " &ndash; ", cuts[-1])
#  }) %>%


#  addLayersControl(overlayGroups = c("Total", "Latinx", "White", "Black", "Asian", "Two or More", "AIAN", "NHPI", "MESA"),
#                   options = layersControlOptions(collapsed = FALSE)) %>% 


#  #default only show one group and turn others off -currently default shows Total first. We can change this easily if Hilton has preferences

#  hideGroup(c( "Latinx", "White", "Black", "Asian", "Two or More", "AIAN", "NHPI", "MESA")) %>%  #base and view 

#  addProviderTiles("CartoDB.Positron")%>%
# setView(-118.1888, 	33.77091	, zoom = 11)


```




```{r}
## make council number a character file
council_district$council_num <- as.character(council_district$council_num) # change council number to character to merge

## merge with council district shape-file
council_district_count <-  council_district %>% 
  left_join(
    report_stoprates_cd_race_person
  ) 

# multiply rate by 100
#population_race_cd$rate <- population_race_cd$rate*100


# get demographics by council district
df_demographics <- population_race_cd %>% select(cd, race, count, rate) %>%  pivot_wider(
  names_from = race,
  names_glue = "{race}_{.value}",
  values_from = c(count:rate)
)

df_stop <- report_stoprates_cd_race_person %>% select(council_num, race, pop_count, stop_count, stop_rate_per1k) %>%  pivot_wider(
 names_from = race,
 names_glue = "{race}_{.value}",
 values_from = c(pop_count:stop_rate_per1k)
)

## merge df_demographics with council_district-- get council_district_demographics
council_district_demographics <- council_district %>% 
  left_join(
    df_demographics, by = c("council_num" = "cd")
  ) 

## merge with stop rate

council_district_demographics <- council_district_demographics %>% left_join(df_stop)
## only keep last name of rep
####council_district_rate <- council_district_rate %>% mutate(representat = gsub(".* ", "", representat))


# convert to scattered dots for plotting
lb_ripa_dots = as_dot_density(
  council_district_count,
  value = "stop_count",
  values_per_dot = 10, ## each dot represents 10
  group = "race"
)

## filter for race groups
nh_black_dots <- lb_ripa_dots %>% filter(race == "nh_black")
nh_white_dots <- lb_ripa_dots %>% filter(race == "nh_white")
aian_dots <- lb_ripa_dots %>%  filter(race == "aian")
latinx_dots <- lb_ripa_dots %>% filter(race == "latinx")
mesa_dots <- lb_ripa_dots %>% filter(race == "mesa")
nh_asian_dots <- lb_ripa_dots %>% filter(race == "nh_asian")
nh_twoormor_dots <- lb_ripa_dots %>% filter(race == "nh_twoormor")
nhpi_dots <- lb_ripa_dots %>% filter(race == "nhpi")


## function to change the legend shape and color
colors_function <- function(colors, sizes, borders, shapes) {
  shapes <- gsub("circle", "100%", shapes)
  shapes <- gsub("square", "100%", shapes)
  paste0(colors, "; width:", sizes, "px; height:", sizes, "px; border:1px solid ", borders, "; border-radius:", shapes)
}


###



### Pop-ups ### ---------------
demographic_popup <- paste0((
  label = paste0(
    "<div class='leaflet-popup-scrolled' style='max-width:800px;max-height:200px'>", 
    "In Council District  <span style='font-size: 14px; font-weight: bold;'>",  council_district_demographics$council_num, 
    
     "</span>, <br> <br> For every 1K  <span style='font-size: 14px; font-weight: bold;'> Black </span> people, LBPD stopped <span style='font-size: 14px; font-weight: bold;'>",
    council_district_demographics$nh_black_stop_rate, "</span> people who identify as Black. <span style='font-size: 14px; font-weight: bold;'>",
   scales::percent(council_district_demographics$nh_black_rate, accuracy = 0.1),"</span> of the population in this district identify as Black. </br <span style='font-size: 14px; font-weight: bold;'>",
   
    "</span> <br> For every 1K  <span style='font-size: 14px; font-weight: bold;'> Latinx </span> people, LBPD stopped <span style='font-size: 14px; font-weight: bold;'>",
    council_district_demographics$latinx_stop_rate, "</span> people who identify as Latinx. <span style='font-size: 14px; font-weight: bold;'>",
   scales::percent(council_district_demographics$latinx_rate, accuracy = 0.1),"</span> of the population in this district identify as Latinx. </br <span style='font-size: 14px; font-weight: bold;'>",
   
      "</span> <br> For every 1K  <span style='font-size: 14px; font-weight: bold;'> Asian </span> people, LBPD stopped <span style='font-size: 14px; font-weight: bold;'>",
    council_district_demographics$nh_asian_stop_rate, "</span> people who identify as Asian. <span style='font-size: 14px; font-weight: bold;'>",
   scales::percent(council_district_demographics$nh_asian_rate, accuracy = 0.1),"</span> of the population in this district identify as Asian. </br> <span style='font-size: 14px; font-weight: bold;'>",
   
     "</span> <br> For every 1K  <span style='font-size: 14px; font-weight: bold;'> White </span> people, LBPD stopped <span style='font-size: 14px; font-weight: bold;'>",
    council_district_demographics$nh_white_stop_rate, "</span> people who identify as White. <span style='font-size: 14px; font-weight: bold;'>",
   scales::percent(council_district_demographics$nh_white_rate, accuracy = 0.1),"</span> of the population in this district identify as White. </br> <span style='font-size: 14px; font-weight: bold;'>",
      
    "</span> <br> For every 1K  <span style='font-size: 14px; font-weight: bold;'> Middle Eastern or South Asian </span> people, LBPD stopped <span style='font-size: 14px; font-weight: bold;'>",
    council_district_demographics$mesa_stop_rate, "</span> people who identify as Middle Eastern or South Asian. <span style='font-size: 14px; font-weight: bold;'>",
   scales::percent(council_district_demographics$mesa_rate, accuracy = 0.1),"</span> of the population in this district identify as Middle Eastern or South Asian. </br> <span style='font-size: 14px; font-weight: bold;'>",
  
   
   
  "</span> <br> For every 1K  <span style='font-size: 14px; font-weight: bold;'> Native Hawaiian or Pacific Islander </span> people, LBPD stopped <span style='font-size: 14px; font-weight: bold;'>",
    council_district_demographics$nhpi_rate_stop_rate, "</span> people who identify as Native Hawaiian or Pacific Islander. <span style='font-size: 14px; font-weight: bold;'>",
   scales::percent(council_district_demographics$nhpi_rate, accuracy = 0.1),"</span> of the population in this district identify as Native Hawaiian or Pacific Islander. </br> <span style='font-size: 14px; font-weight: bold;'>",
   
   
    "</span> <br> For every 1K  <span style='font-size: 14px; font-weight: bold;'> American Indian and Alaska Native </span> people, LBPD stopped <span style='font-size: 14px; font-weight: bold;'>",
    council_district_demographics$aian_stop_rate, "</span> people who identify as American Indian and Alaska Native. <span style='font-size: 14px; font-weight: bold;'>",
   scales::percent(council_district_demographics$aian_rate, accuracy = 0.1),"</span> of the population in this district identify as American Indian and Alaska Native. </br> <span style='font-size: 14px; font-weight: bold;'>",
 
   
       "</span> <br> For every 1K  <span style='font-size: 14px; font-weight: bold;'> Two or More Races </span> people, LBPD stopped <span style='font-size: 14px; font-weight: bold;'>",
    council_district_demographics$nh_twoormor_stop_rate, "</span> people who identify as Two or More Races. <span style='font-size: 14px; font-weight: bold;'>",
   scales::percent(council_district_demographics$nh_twoormor_rate, accuracy = 0.1),"</span> of the population in this district identify as Two or More Races. </br> <span style='font-size: 14px; font-weight: bold;'>"
   



)))


# colors according to our brand guide: https://catalystcalifornia.sharepoint.com/sites/Portal/AP%20Projects/Forms/AllItems.aspx?FolderCTID=0x012000EF0283621C7FE048A8E68512F119353B&id=%2Fsites%2FPortal%2FAP%20Projects%2FCommunications%2FCatalyst%20California%2FBranding%20Materials%20%2B%20Templates%2FVisual%20Brand%20Guide%2FCatalyst%20California%20Brand%20Guide%5FSeptember%202022%2Epdf&viewid=1aaeb4a9%2D2232%2D41c7%2Da71c%2D727af9e1f5d7&parent=%2Fsites%2FPortal%2FAP%20Projects%2FCommunications%2FCatalyst%20California%2FBranding%20Materials%20%2B%20Templates%2FVisual%20Brand%20Guide

# Base Color 00
lime_green <- c('#0AB013')
persian_indigo <- c('#211447')
halloween_orange <- c('#DF4007')
bitter_lemon <- c('#BCD313')
blue <- c('#0860BC')
#dark_tangerine <- c('#EB8D00')
american_yellow <- c('#EABB00')
halaya_ube <- c('#601D42')
dark_silver <- c('#6F6F6F') 



### change size of legend

 leaflet(width = "100%", height = "600px") %>%

    ### add latinx dots
  
 addCircleMarkers(data = latinx_dots, group = "Latinx", label = NULL, weight = 2, fillOpacity = 1, radius = 2, color="white",  fillColor= lime_green,  stroke = TRUE) %>% 
   
  ## add NH Black Stops
  
addCircleMarkers(data = nh_black_dots, group = "Black", label = NULL, weight = 2, fillOpacity = 1, radius = 2, color="white",  fillColor=blue, stroke = TRUE) %>% 
   
   ### add nh asian dots
  
 addCircleMarkers(data = nh_asian_dots, group = "Asian", label = NULL, weight = 2, fillOpacity = 1, radius = 2, color="white",  fillColor=  halloween_orange, stroke = TRUE) %>% 
   
  
  ## add NH White Stops
  
 addCircleMarkers(data = nh_white_dots, group = "White", label = NULL, weight = 2, fillOpacity = 1, radius = 2, color="white",  fillColor=  bitter_lemon,  stroke = TRUE) %>% 
   
    ### add MESA dots
  
 addCircleMarkers(data = mesa_dots, group = "MESA", label = NULL, weight = 2, fillOpacity = 1, radius = 2, color="white",  fillColor= american_yellow, stroke = TRUE) %>% 
  
  
   ### add nhpi dots
  
 addCircleMarkers(data = nhpi_dots, group = "NHPI", label = NULL, weight = 2, fillOpacity = 1, radius = 2, color="white",  fillColor= halaya_ube, stroke = TRUE) %>% 
   
  ### add AIAN dots 
  
 addCircleMarkers(data = aian_dots,  group = "AIAN", label = NULL, weight = 2, fillOpacity = 1, radius = 2, color="white",  fillColor= dark_silver, stroke = TRUE) %>% 
  
  ### add nh two or more dots
  
 addCircleMarkers(data = nh_twoormor_dots, group = "Two or More Races", label = NULL, weight = 2, fillOpacity = 1, radius = 2, color="white",  fillColor= persian_indigo, stroke = TRUE) %>% 
  

  
   # add Long beach district layer with stop rates
  addPolygons(data = council_district_demographics, label=~htmlEscape(paste0("Council Number ", council_num)), color = "black", fillColor = "white", opacity = 1,  popup = ~paste0(demographic_popup), 
            weight = 2, smoothFactor = 0.5,  highlight = highlightOptions(color = "white", weight = 3, bringToFront = TRUE, sendToBack = FALSE)) %>%
  
  addLayersControl(overlayGroups = c("Latinx","Black",  "Asian", "White",  "MESA", "NHPI", "AIAN", "Two or More Races"),
                   options = layersControlOptions(collapsed = FALSE))  %>%
  
  
  
  ## add Legend
  
   addLegend(position = "bottomleft",   title = "1 dot = 10 people stopped", colors = "", labels = "") %>%
  
   addLegend(position = "bottomleft",   title = "", group = "Latinx", labels = c("Latinx"), colors = colors_function(colors = lime_green, sizes = "10", shapes = "circle", borders = NULL) ) %>%
  
  addLegend(position = "bottomleft",   title = "", group = "Black", labels = c("Black"), colors = colors_function(colors = blue, sizes = "10", shapes = "circle", borders = NULL) ) %>%
   
   addLegend(position = "bottomleft",   title = "", group = "Asian", labels = c("Asian"), colors = colors_function(colors = halloween_orange, sizes = "10", shapes = "circle", borders = NULL) ) %>%
  
    addLegend(position = "bottomleft",   title = "", group = "White", labels = c("White"), colors = colors_function(colors =  bitter_lemon, sizes = "10", shapes = "circle", borders = NULL) ) %>%
   
      addLegend(position = "bottomleft",   title = "", group = "MESA", labels = c("Middle Eastern or South Asian"), colors = colors_function(colors = american_yellow, sizes = "10", shapes = "circle", borders = NULL) ) %>%
  
    addLegend(position = "bottomleft",   title = "", group = "NHPI", labels = c("Native Hawaiian or Pacific Islander"), colors = colors_function(colors =halaya_ube, sizes = "10", shapes = "circle", borders = NULL) ) %>%
  
   addLegend(position = "bottomleft",   title = "", group = "AIAN", labels = c("American Indian or Alaska Native"), colors = colors_function(colors = dark_silver, sizes = "10", shapes = "circle", borders = NULL) ) %>%
  

   addLegend(position = "bottomleft",   title = "", group = "Two or More Races", labels = c("Two or More Races"), colors = colors_function(colors =persian_indigo, sizes = "10", shapes = "circle", borders = NULL) ) %>%
  
 
  
  
  #base and view
  
  addProviderTiles("CartoDB.Positron")%>%
  setView(-118.16675, 	33.80462	, zoom = 12) %>% #base and view 
  
  hideGroup(c("White"))   # hide white group
 
 
 #<span style=' font-size: 12px;'>Race/ethnicity: AIAN=American Indian or Alaska Native, NHPI=Native Hawaiian or Pacific Islander, MESA=Middle Eastern or South Asian; Observations by race may overlap in the point density map.</span style>

#<span style='float: left; font-size: 12px;'>Catalyst California's calculations based on City of Long Beach's Police Stop Data (2019); <u>[Catalyst California](https://www.catalystcalifornia.org)</u>, 2023.</span style>

```
<span style=' font-size: 12px;'>Race/ethnicity: AIAN=American Indian or Alaska Native, NHPI=Native Hawaiian or Pacific Islander, MESA=Middle Eastern or South Asian; Observations by race may overlap in the point density map. </span> 
<br> <span style=' font-size: 12px;'>Catalyst California's calculations based on City of Long Beach's Police Stop Data (2019); <u>[Catalyst California](https://www.catalystcalifornia.org)</u>, 2023. Analysis for all officer-initiated stops.</span>


### More hours are spent on unnecessary stops in communities of color that have fewer resources.

More stops in a community does not coincide with a greater likelihood of preventing or detecting serious crime. We calculated the percent of hours in each Council District that resulted in stops with no action. Council Districts 9,8,1, and 6 have higher rates of stops where an officer found no reason to take action, or even cite, a person. In Council District 9, nearly 1 in 5 hours (18.9%) spent on officer-initiated stops resulted in no action.

```{r, echo=FALSE}
#### DS ####

##### Map - officer initiated stops that resulted with no action  by council district #####
council_district_noaction <- council_district %>% 
  mutate(council_num=as.character(council_num))%>% #added this mutation because 'council_num' needs to be the same type for both dfs in order to be the join key
  left_join(
    report_timespent_officerinitiated_cd_stop
  ) 
## only keep last name of rep
council_district_noaction <- council_district_noaction %>% mutate(representat = gsub(".* ", "", representat))

## add link
council_district_noaction$link <- c("https://www.longbeach.gov/district4/", "https://www.longbeach.gov/district5/","https://www.longbeach.gov/district3/","https://www.longbeach.gov/district1/","https://www.longbeach.gov/district8/","https://www.longbeach.gov/district6/","https://www.longbeach.gov/district9/","https://www.longbeach.gov/district7/","https://www.longbeach.gov/district2/")


cc_brand <- c("#E2D9FF", "#BDAFE9","#8E7ACA", "#362178","#211447")


hours_rate_noaction_cap_popup <- paste0((
label = paste0(
   "In Council District  <span style='font-size: 14px; font-weight: bold;'>",  
 council_district_noaction$council_num,  "<a href=",council_district_noaction$link, ">", "</span> (Rep. <span style='font-size: 12px; font-weight: bold;'>",council_district_noaction$representat, "</span>) ", "</a>",

 " ,officers spent <span style='font-size: 12px; font-weight: bold;'>", 
 scales::comma(council_district_noaction$hours_count_noaction_cap, accuracy = 0.1), "</span> hours in stops that resulted in no action, a rate of <span style='font-size: 14px; font-weight: bold;'> ", scales::comma(council_district_noaction$hours_rate_noaction_cap, accuracy = 0.1), "</span>%.")))



#'<a href=',  p_spdf$Link, '>', p_spdf$Link, '</a>'


#palette purples
pal_stop_hours_rate_noaction_cap <- colorQuantile(cc_brand,council_district_noaction$hours_rate_noaction_cap, n = 5)


leaflet(width = "100%", height = "495px") %>%
  # add Long beach district layer with stop rates
  addPolygons(data =  council_district_noaction,  label=~htmlEscape(paste0("Council Number ", council_num)), color = "black", weight = 2, smoothFactor = 0.5, opacity = 1, fillOpacity = 0.5, popup = ~paste0(hours_rate_noaction_cap_popup),
              fillColor = ~pal_stop_hours_rate_noaction_cap(hours_rate_noaction_cap), highlight = highlightOptions(color = "white", weight = 3, bringToFront = TRUE, sendToBack = FALSE), group = "") %>%
  
  ## add legend for stop hours
  addLegend(position = "bottomleft", pal = pal_stop_hours_rate_noaction_cap, values = council_district_noaction$hours_rate_noaction_cap, opacity = .5, title = "Percent of Hours Spent on Stops with No Action", na.label = NA, labFormat = function(type, cuts, p) {
    n = length(cuts)
    paste0(scales::comma(cuts, accuracy = .1)[-n], " &ndash; ", scales::comma(cuts, accuracy = .1)[-1], "%")
  }) %>%

  
  #base and view
  
  addProviderTiles("CartoDB.Positron")%>%
  setView(-118.16675, 	33.80462	, zoom = 12) #base and view 

```
<br> <span style=' font-size: 12px;'>Catalyst California's calculations based on City of Long Beach's Police Stop Data (2019); <u>[Catalyst California](https://www.catalystcalifornia.org)</u>, 2023. Analysis for all officer-initiated stops.</span>


## Stops do not lead to greater safety for communities affected by inequities.

A common narrative may be that traffic stops lead to safer streets with fewer injuries and less crime. In reality, communities of color are often the communities with higher rates of injuries from traffic collisions and profiling by police. Comparing traffic collisions to traffic stops shows officer-initiated stops do not necessarily make roadways safer nor do they correlate to areas with higher risk of road injuries. These stops are also ineffective in preventing serious crime. LBPD overwhelming conducts unnecessary searches of people through traffic stops, finding nothing of consequence. People of color bare the largest impact of these stops.

### Traffic stops do not correlate to safer streets for communities impacted traffic injuries.

We compared 2019 traffic stops to high-injury corridors and intersections identified by the Safe Streets Long Beach initiative. The initiative identified these high-injury corridors and intersections based on 2013-17 data, but they remain the initiative's action plan to guarantee equity in increasing road safety. Council Districts 1 and 6 have the highest rate of traffic stops, but they also have the highest concentration of high-injury motor, pedestrian, and bike networks. Rather than improving safety in these highly impacted communities, officer-initiated traffic stops can lead to greater harm by more contact and exposure to the police. 


```{r, echo=FALSE}
#### DS ####

##### Map - map comparing traffic stop rates to injury networks #####
#source("W:/Project/ECI/LB RIPA/R/3. Safety/report_highinjury_corridors_intersections.R")

# merge stop rates by council district shape-file -----------------------------------
council_district$council_num <- as.character(council_district$council_num) # change council number to character to merge

df <- report_traffic_stoprates_cd_race_person %>% select(council_num, race, pop_count, traffic_stop_count, traffic_stop_rate) %>%  pivot_wider(
  names_from = race,
  names_glue = "{race}_{.value}",
  values_from = c(pop_count:traffic_stop_rate)
)

## get traffic stop rate by council number
council_district$council_num <- as.character(council_district$council_num)

# merge
council_district_traffic_rate <- council_district %>% 
  left_join(
    df
  ) 

## only keep last name of rep
council_district_traffic_rate <- council_district_traffic_rate %>% mutate(representat = gsub(".* ", "", representat))


council_district_traffic_rate$link <- c("https://www.longbeach.gov/district4/", "https://www.longbeach.gov/district5/","https://www.longbeach.gov/district3/","https://www.longbeach.gov/district1/","https://www.longbeach.gov/district8/","https://www.longbeach.gov/district6/","https://www.longbeach.gov/district9/","https://www.longbeach.gov/district7/","https://www.longbeach.gov/district2/")

### remove Long Beach, CA from pop-up

high_injury_motor_intersections_spdf <- high_injury_motor_intersections_spdf  %>% mutate(address= gsub(", Long Beach, CA, USA", "", address))
high_injury_ped_intersections_spdf <- high_injury_ped_intersections_spdf  %>% mutate(address= gsub(", Long Beach, CA, USA", "", address))
high_injury_motor_corridors_line_sf <- high_injury_motor_corridors_line_sf %>% mutate(address_1= gsub(", Long Beach, CA, USA", "", address_1),
                                                                   address_2= gsub(", Long Beach, CA, USA", "", address_2),)
high_injury_ped_corridors_line_sf <- high_injury_ped_corridors_line_sf  %>% mutate(address_1= gsub(", Long Beach, CA, USA", "", address_1),
                                                                   address_2= gsub(", Long Beach, CA, USA", "", address_2),)



###############
####Pop-Ups####
###############

high_injury_motor_intersections_popup <- paste0((
  label = paste0(
    "There were approximately <span style='font-weight: bold;'>", high_injury_motor_intersections_spdf$num_killed_or_seriously_injured, "</span> killed or seriously injured, <span style='font-size: 12px; font-weight: bold;'>",  
    high_injury_motor_intersections_spdf$num_vehicle_crashes, "</span> vehicle crash(es), and <span style='font-size: 12px; font-weight: bold;'>", high_injury_motor_intersections_spdf$num_motorcycle_crashes,"</span> motorcycle crash(es) at the intersection of <span style='font-size: 12px; font-weight: bold;'>",  
    high_injury_motor_intersections_spdf$address,".")))


high_injury_ped_corridors_popup <- paste0((
  label = paste0(
    "There were approximately <span style='font-weight: bold;'>", high_injury_ped_corridors_line_sf$num_killed_or_seriously_injured, "</span> killed or seriously injured and <span style='font-size: 12px; font-weight: bold;'>",  
    high_injury_ped_corridors_line_sf$num_crashes, "</span> pedestrian or bicycle crash(es), at corridor <span style='font-size: 12px; font-weight: bold;'>",
    high_injury_ped_corridors_line_sf$corridor, "</span>. This corridor runs from <span style='font-size: 12px; font-weight: bold;'>", high_injury_ped_corridors_line_sf$address_1, "</span> to <span style='font-size: 12px; font-weight: bold;'>", high_injury_ped_corridors_line_sf$address_2, ".")))






high_injury_motor_corridors_popup <- paste0((
  label = paste0(
    "There were approximately <span style='font-weight: bold;'>", high_injury_motor_corridors_line_sf$num_killed_or_seriously_injured, "</span> killed or seriously injured and <span style='font-size: 12px; font-weight: bold;'>",  
    high_injury_motor_corridors_line_sf$num_crashes, "</span> vehicle or motorcycle crash(es), at corridor <span style='font-size: 12px; font-weight: bold;'>",
    high_injury_motor_corridors_line_sf$corridor, "</span>. This corridor runs from <span style='font-size: 12px; font-weight: bold;'>", high_injury_motor_corridors_line_sf$address_1, "</span> to <span style='font-size: 12px; font-weight: bold;'>", high_injury_motor_corridors_line_sf$address_2,".")))




high_injury_ped_intersections_popup <- paste0((
  label = paste0(
    "There were approximately <span style='font-weight: bold;'>", high_injury_ped_intersections_spdf$num_killed_or_seriously_injured, "</span> killed or seriously injured, <span style='font-size: 12px; font-weight: bold;'>",  
    high_injury_ped_intersections_spdf$num_ped_crashes, "</span> pedestrian crash(es), and <span style='font-size: 12px; font-weight: bold;'>", high_injury_ped_intersections_spdf$num_bike_crashes,"</span> bike crash(es) at the intersection of <span style='font-size: 12px; font-weight: bold;'>",  
    high_injury_ped_intersections_spdf$address,".")))


#### traffic stop rate pop_up ####

total_traffic_rate_popup <- paste0((
 label = paste0(
    "For every 1K <span style='font-weight: bold;'>Total</span> people in Council District  <span style='font-size: 12px; font-weight: bold;'>",  
   council_district_traffic_rate$council_num, "<a href=",council_district_traffic_rate$link, ">", "</span> (Rep. <span style='font-size: 12px; font-weight: bold;'>", council_district_traffic_rate$representat,"</span>) ", "</a>", ",LBPD stopped <span style='font-size: 12px; font-weight: bold;'>",council_district_traffic_rate$total_traffic_stop_rate, "</span>  people, a total of <span style='font-size: 12px; font-weight: bold;'> ", scales::comma(council_district_traffic_rate$total_traffic_stop_count), "</span> people. ")))
  
  


## palette #2

#cc_brand2 <- c('#FFbDA6', '#FF9873', '#FA7B4D', '#F25922', '#DF4007')

#palette colors for dots/lines

papaya_orange <- c("#DF4007")
american_yellow <- c("#EABB00")

#peridot <- c("#CEEA01")

cc_brand <- c("#E2D9FF", "#BDAFE9","#8E7ACA", "#362178","#211447")

pal_total <- colorQuantile(cc_brand, council_district_traffic_rate$total_traffic_stop_rate, n = 5)

## function to change the legend shape and color

#colors_function_circle <- function(colors, sizes, borders, shapes) {
 # shapes <- gsub("circle", "100%", shapes)
 # paste0(colors, "; width:", sizes, "px; height:", sizes, "px; border:1px solid ", borders, "; border-radius:", shapes)
#}



leaflet(width = "100%", height = "495px") %>%
  
  
  # add Long beach district layer with stop rates
  addPolygons(data = council_district_traffic_rate,  label=~htmlEscape(paste0("Council Number ", council_num)), color = "#444444", weight = 2, smoothFactor = 0.5,  opacity = 1, fillOpacity = 0.5,  fillColor = ~pal_total(total_traffic_stop_rate),
              popup = ~paste0(total_traffic_rate_popup), highlight = highlightOptions(color = "white", weight = 3, bringToFront = FALSE), group = "Council Districts") %>%
  
  ## add motor corridors 
  addPolylines(data = high_injury_motor_corridors_line_sf, group = "High Injury Motor Intersections/Corridors",
               popup= ~paste0(high_injury_motor_corridors_popup),
               label= ~htmlEscape(paste0("High Injury Motor Intersections/Corridors")),
             
              color = american_yellow, weight = 2, opacity =1) %>%
  
  ## add pedestrian/bike corridors
  addPolylines(data = high_injury_ped_corridors_line_sf, group = "High Injury Pedestrian or Bike Intersections/Corridors",
               popup= ~paste0(high_injury_ped_corridors_popup),
               label= ~htmlEscape(paste0("High Injury Pedestrian or Bike Intersections/Corridors")),
              
               color = papaya_orange, weight = 2, opacity = 1) %>%
  
  
  
  ## add motor intersections
  addCircleMarkers(data = high_injury_motor_intersections_spdf, lat = ~lat, lng = ~lon,
                   group="High Injury Motor Intersections/Corridors",
                   popup= ~paste0(high_injury_motor_intersections_popup),
                   label= ~htmlEscape(paste0("High Injury Motor Vehicle/Motorcycle Intersection")),
                   weight = 2, fillOpacity = 1, radius=4,
                    color = "black", fillColor= american_yellow, stroke = TRUE
  ) %>%
  
  ## add pedestrian/bike intersections
  addCircleMarkers(data = high_injury_ped_intersections_spdf, lat = ~lat, lng = ~lon,
                   group="High Injury Pedestrian or Bike Intersections/Corridors",
                   popup= ~paste0(high_injury_ped_intersections_popup),
                   label= ~htmlEscape(paste0("High Injury Pedestrian or Bike Intersections/Corridors")),
                   weight = 2, fillOpacity = 1, radius=4,
                   color="black",  fillColor= papaya_orange, stroke = TRUE
  ) %>%
  
  
  
  ## add legend for stop rate
  addLegend(layerId = "Total", position = "bottomleft", group = "Total", pal = pal_total, values = council_district_traffic_rate$total_traffic_stop_rate, opacity = .5, title = "Traffic Stop Rate Per 1K Total Residents", na.label = NA, labFormat = function(type, cuts, p) {
    n = length(cuts)
    paste0(cuts[-n], " &ndash; ", cuts[-1])
  })  %>%
  
 #### CORRIDOR LEGEND

## add legend for corridors
##  addLegendLine(position = "bottomleft",values = 0, title = "Motor Corridors",  group = "High Injury Motor Intersections/Corridors",  baseSize = 5, width = 50, color = peridot) %>%
  
    ## add legend for corridors
#  addLegendLine(position = "bottomleft",values = 0, title = "Pedestrian or Bike Corridors",  group = "High Injury Pedestrian or Bike Intersections/Corridors",  baseSize = 5, width = 50, color = papaya_orange) %>%
  
  ### PEDESTRIAN LEGEND
  
  ## add legend for intersections
#   addLegend(position = "bottomleft",   title = "", group = "High Injury Pedestrian or Bike Intersections/Corridors", labels = "Pedestrian or Bike Intersections", colors = colors_function_circle(colors =papaya_orange, sizes = "10", shapes = "circle", borders = NULL) ) %>%
  

 #  addLegend(position = "bottomleft",   title = "", group = "High Injury Motor Intersections/Corridors", labels = "Motor Intersections", colors = colors_function_circle(colors =peridot, sizes = "10", shapes = "circle", borders = NULL) ) %>%
  
  
  #layer control
  
  addLayersControl(overlayGroups =  
                     c("High Injury Motor Intersections/Corridors", "High Injury Pedestrian or Bike Intersections/Corridors"), 
                   options = layersControlOptions(collapsed = FALSE)) %>%  
  
  #  htmlwidgets::onRender("
  #     function() {
  #         $('.leaflet-control-layers-list').prepend('<label style=\"text-align:center\">High Injury Corridors and Intersections</label>');
  #      }
  #  ") %>%
  
  #base and view
  
  addProviderTiles("CartoDB.Positron") %>%
  setView(-118.16675, 	33.80462	, zoom = 12) %>% #base and view 
  
  hideGroup(c("Pedestrian/Bike"))
```
<br> <span style=' font-size: 12px;'>Catalyst California's calculations based on City of Long Beach's Police Stop Data (2019); <u>[Catalyst California](https://www.catalystcalifornia.org)</u>, 2023. Analysis for all officer-initiated stops for traffic violations.</span>



### Traffic stops lead to unnecessary searches by officers that harm people of color.

Instead of creating safer communities, officers use routine traffic stops as a means to profile and harass people of color. LBPD officers use routine traffic stops to search people with the purported intent of preventing more serious crime. This practice yields ineffective results. The majority of searches, nearly 4 in 5 across races, lead to no contraband or evidence found for a crime. Nearly 90% of searches done during traffic stops of MESA, Black, Multi-racial, Asian, and AIAN individuals result in no contraband or evidence found. 

```{r, echo=FALSE}
#### DS ####
report_hitrates_race_person<-report_hitrates_race_person%>%filter(race!="total")
##### Chart - unfounded searches by race for traffic violations #####

# Apply Chart

fx_barbubblechart(

  db=report_hitrates_race_person, #name of dataframe

  order_var=report_stoprates_race_person$hit_rates, #variable you're sorting by

  x='race_label_short', # x or independent variables

  y='hit_rates', # y or dependent variable

  z='evidence_not_found',

 top_finding=paste0("Most searches LBPD conducts during traffic stops lead to no evidence or contraband found."), # this is the top finding from the chart that gets used like a title


   chart_title= paste0("Searches with No Contraband or Evidence Found among Traffic Stops by Race"), # this is the more standard chart title that gets used as a subtitle


  tooltip_text="For every 100 searches done during traffic stops of people perceived as <b>{point.race_label_long}</b>, LBPD did not find contraband/evidence in <b>{point.hit_rates:.0f}</b> stops,  a total of <b>{point.evidence_not_found:.0f}</b> unnecessary searches.", # customize your tooltip as a statement, calling out rate and count


    chart_caption = paste0(racenote,"<br>", sourcenote, "<br>", "Analysis for all officer-initiated traffic stops where a search occurred."), # if necessary add a method note between the racenote and sourcenote with a line break, use racenote if graph includes data by race, and always use sourcenote. Each of these are standard objects across all charts


 yaxis_label = "''", #format for your y axis labels
  export_data_label=list(pointFormat='{point.hit_rates:.1f}%') # format for your data labels on export images
)


```

# The Solution

# The Takeaway
