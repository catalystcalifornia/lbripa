---
title: "Disparities in LBPD's Practices"
subtitle: "DRAFT"
author: "Catalyst California"
output:
  html_document:
    css: "W:\\RDA Team\\R\\cc_brandguide.css"
    code_folding: hide
    toc: yes
    toc_depth: 2
    toc_float: yes
date: "`r format(Sys.time(), '%d %B, %Y')`"
---
  
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">
```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, message=FALSE, warning=FALSE)


list.of.packages <- c("usethis", "highcharter", "tidyverse", "sf", "leaflet", "sp", "htmltools", "magrittr", "flextable", "htmlwidgets")

new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)

#### Load libraries ####
library(usethis)
library(highcharter)
library(tidyverse)
library(sf)
library(leaflet)
library(sp)
library(htmltools) # for html escape
library(magrittr)
#library(leaflegend) # customize legends to change shapes:: commenting out because not needed for high injury network maps for now
library(flextable)

library(htmlwidgets)


#### Add database connection ####
source("W:\\RDA Team\\R\\credentials_source.R")

con <- connect_to_db("eci_lb_ripa")

## Source the Chart Template

source("W:/Project/ECI/LB RIPA/R/chart_functions.R")


```


# The Context 

We all want to live in safe communities. We currently spend tremendous public dollars on law enforcement to achieve that goal. This approach assumes that investing in law enforcement is an efficient way to ensure safety. However, data on police activity show otherwise. When patrolling communities, police often spend most of their time stopping people for minor vehicle equipment and administrative issues, such as a broken taillight, an object hanging from a rearview mirror, or outdated registration. Research shows that dedicating public resources to such non-safety-related traffic stops undermines community safety and inflicts devastating harms on people of color (including trauma, dehumanization, and economic extraction). It also reduces our capacity for meaningful investments in the upstream drivers of traffic safety risks, such as making roadways and vehicles safer.  

The Long Beach Police Department (LBPD) has historically over-policed and racially profiled people of color. This trend continues today. Using data collected based on the Racial & Identity Profiling Act (RIPA), we find that LBPD spent most of their patrol time stopping people for traffic infractions rather than responding to community concerns about more serious safety issues. These practices do not meaningfully improve safety, but also inflict significant harms on Black, Latinx, Native Hawaiian or Pacific Islander, and Middle Eastern and South Asian people. Now is the time for Long Beach to invest in alternatives to law enforcement that make communities safe for all people. 

# The Data

We use RIPA data to analyze LBPD patrol activities, including how their stops impact different communities. RIPA requires law enforcement agencies, like LBPD, to collect and report data on all pedestrian and vehicle stops, including the reason for the stop, the race of the person stopped as perceived by the officer, what actions occurred during the stop, among other information. We use 2019 stop data because it was the most recent year of data available at the time of analysis that was not affected by significant changes caused by the COVID-19 pandemic (such as “stay-at-home" orders and other policies that impacted daily life activities). We examine stops by the amount of time spent on different types of stops, stop results, and racial disparities amongst the people stopped in different geographic regions (i.e., city council districts). In sum, the data show that LBPD racially profiles people of color in Long Beach, burdening communities of color with exposure to police rather than contributing to community safety. 

## LBPD spends most of their patrol time on officer-initiated traffic stops that are racially biased and not a threat to safety

A common narrative is that spending a significant amount of public dollars on police is necessary to prevent serious crimes from occurring. In theory, officers are primarily fighting crime and responding to requests for assistance when dangerous situations arise. However, the data show otherwise.  Specifically, data show that LBPD patrol time is mostly dedicated to racially biased officer-initiated stops for traffic violations rather than more serious issues, such as violence.   

In RIPA data, officers must report if they made a stop in response to a call for service (e.g. 911 call) or initiated a stop themselves. We refer to these stops as calls for service and officer-initiated stops, respectively. They also must report the overarching reason for the stop, including if the stop was made for a traffic violation, reasonable suspicion for a crime, or other reason.  A third important category is the result of a stop—such as whether a person was cited, arrested, or no action occurred at all. 

In this analysis, we examine LBPD 2019 RIPA data to learn the reasons police used to make stops, how frequently stops were made, the amount of time spent on stops, and how stops varied by race. We find that LBPD patrol spends more time, and thereby public resources, on stops that are officer-initiated and not responses to calls from the community. These stops are also commonly for traffic violations that do not require an armed officer response and disproportionately affect people of color. 

### LBPD spends most of their patrol time on officer-initiated stops rather than responding to concerns from the community  

Nearly 76% of LBPD patrol time (or 3 out of every 4 hours) is spent on officer-initiated stops, and only 24% (or 1 in 4 hours) is spent responding to calls for service from the community. Our analysis focuses on officer-initiated stops given the large percentage of time officers spend on these stops and to evaluate the results of stops officers initiated themselves.^[However, prior research shows even stops made in response to a call for service come with threats to the safety of people of color. Community members may choose to make unjustified 911 calls or calls to law enforcement based on their own biases, including racial bias against people of color, rather than real threats to safety. How officers and dispatchers respond to these calls is also affected by bias where reports from White people may be more valued than reports from people of color. These calls and responses to those calls by officers can lead to mental and physical trauma for people of color based on threat to their safety and reputation.
See Racial and Identity Profiling Advisory Board, Annual Report (2021) p. 101 <https://oag.ca.gov/sites/all/ f iles/agweb/pdfs/ripa/ripa-board-report-2021.pdf> [as of Nov. 29, 2022] (citing Fridell, Producing Bias-Free Policing: A Science-Based Approach (2017) Springer Internat. Publishing, p. 90 <http://ndl.ethernet.edu.et/ bitstream/123456789/15169/1/90.pdf.pdf> [as of Nov. 29, 2022]).
Alang et al., Police Brutality and Black Health: Setting the Agenda for Public Health Scholars (2017) 107 Am. J. Pub. Health 662 <https://www.researchgate.net/publication/315510199_Police_Brutality_and_Black_ Health_Setting_the_Agenda_for_Public_Health_Scholars> [as of Nov. 29, 2022]
]  

```{r, echo=FALSE}
#### JZ ####

##### Chart - % time spent on cfs vs. officer-initiated stops #####

#read in table
df<-dbGetQuery(con, "SELECT * FROM report_timespent_cfs_stop")

# create donut chart

df %>%
  hchart(
    "pie", hcaes(x = label, y = hours_rate_cap),
    name = "",
    tooltip = list(headerFormat="", pointFormat = "<b>{point.hours_rate_cap:.1f}%</b> of hours are spent on <b>{point.label}</b>, or a total of {point.hours_count_cap:,.1f} hours"),
     innerSize="65%",
     center = c(50, 50), 
    )%>% 
  hc_title(text = "Three in four hours are spent on officer-initiated stops not calls for service",
 align="left")%>%
   hc_subtitle(text = "Percent of Hours Spent on Calls for Service versus Officer-initiated Stops",
                     align="left") %>%
  hc_caption(
    text = paste0(sourcenote))%>%
  hc_plotOptions(
    innersize="50%", 
    startAngle=90, 
    endAngle=90,
    center=list('50%', '75%'),
    size='120%')%>%
hc_add_theme(cc_theme)%>%
  hc_exporting(
    enabled = TRUE, sourceWidth=900, sourceHeight=600, 
    chartOptions=list(plotOptions=list(series=list(dataLabels=list(enabled=TRUE, format='{point.hours_rate_cap:.1f}%')))),
    filename = paste0("Percent of hours spent on calls for service versus officer-initiated stops","_Catalyst California, catalystcalifornia.org, 2023.")
  )

```



### Officer-initiated stops are largely dedicated to traffic violations for offenses that rarely require an arrest  {.tabset}

Looking at officer-initiated stops, we analyze the time officers spent on stops by stop reason and then by result to determine if officers are making stops that help prevent serious threats to community safety. We find that stops are made mainly for traffic violations that are resolved with a citation, warning, or no action. LBPD makes almost 2 in 3 (or 61.7% of stops) for traffic violations. If we distribute these traffic stops across 100 hours and look at how officers spend their time based on the result of the stop, we see over half of those hours (54.5) goes towards stops resolved with a citation, 16.9 towards those resolved with a warning, and 11.3 resolved with no action at all. Only 4.6 out of 100 hours, are spent on stops that result in an arrest. 
The top five offenses that people are cited for are infractions related to moving violations.    Transportation and criminal justice research suggests that, rather than having law enforcement stop people and issue fines and fees through tickets, street design improvements (like narrowing travel lanes) are more effective means at reducing speed and preventing serious injuries than direct police contact.^[NACTO Global Designing Cities Initiative, “Global Street Design Guide.”] ^[https://catalyst-ca.cdn.prismic.io/catalyst-ca/126c30a8-852c-416a-b8a7-55a90c77a04e_APCA+ACLU+REIMAGINING+COMMUNITY+SAFETY+2022_5.pdf, pg. 22]     


#### Time spent on stops by reason

```{r, echo=FALSE, include=FALSE}

###JZ###

#  Chart - % time spent on stops by stop reason:
# ideally these charts should be on a carousel (https://www.r-bloggers.com/2017/04/slickr/)

#read in table

df<-dbGetQuery(con, "SELECT * FROM report_timespent_reason_stop")%>%
  arrange(-hours_rate)

#####  Lollipop #####

# apply lollypop chart function

# Apply Chart 

fx_lollichart(
  df, #name of dataframe
  order_var=df$hours_rate, #variable you're sorting by
  x='stop_reason_short', # x or independent variables
  y='hours_rate', # y or dependent variable

  top_finding=paste0("Officers spend most of their time on traffic stops and stops for reasonable suspicion"), # this is the top finding from the chart that gets used like a title

  chart_title= paste0("Hours Spent on Stops by Stop Reason"), # this is the more standard chart title that gets used as a subtitle

  tooltip_text="<b>{point.hours_rate:.1f}%</b> of hours are spent on <b>{point.stop_reason_short}</b>, or a total of {point.hours_count:,.1f} hours",

  chart_caption = paste0(sourcenote),
  yaxis_label = "'%'", #format for your y axis labels
  export_data_label=list(pointFormat='{point.hours_rate:.1f}% of hours spent'))


```

```{r, include=FALSE}

####Item chart####

  # mutate(hours_rate= round(hours_rate, 0))

col <-c(meteorite, lavender, orange, peridot, "#177FEB", "#733256", "#9B9A9A")  


#### Item Chart 1: Traffic Stops + Results -rate of hours (/100) ####

hc<-hchart(
  df,
  "item",
    rows=6,
  tooltip = list(headerFormat="", pointFormat = "Out of 100 hours, LBPD spent <b>{point.hours_rate:.1f}</b> hours on stops for <b>{point.stop_reason_short}</b>"),
  hcaes(
    name = stop_reason_short,
    y = hours_rate,
    label = stop_reason_short,
    color = col
  ),
  name = "Total Hours",
  showInLegend = TRUE) %>%
  
  hc_title(text = "LBPD spends most of its time on traffic stops", 
 align="left" )%>%
  
  hc_caption(
    text = paste0(sourcenote)) %>% 
  hc_add_theme(cc_theme)%>%
  hc_exporting(
    enabled = TRUE, sourceWidth=900, sourceHeight=600, 
    chartOptions=list(plotOptions=list(series=list(dataLabels=list(enabled=TRUE, format=paste0(list(pointFormat='{point.hours_rate:.1f}')))))),
    filename = paste0("Hours spent on stops by stop reason","_Catalyst California, catalystcalifornia.org, 2023.")
  )%>%
  
  hc_legend(title=list(text='<span style="font-size: 12px; color: #000000; font-weight: bold">Single dot represents 1 hour out of 100 hours</span><br/><span style="font-size: 10px; color: #666; font-style: italic">Click to hide</span>'),
            enable = TRUE, 
            labelFormat = '{name} <span style="opacity: 0.4">{hours_rate:.1f}</span>')

 # hc

# add in margins so the graph isn't cut off

hc %>%
  hc_chart(
    marginRight = 100,
    marginLeft=100
  )



```

```{r}

#read in table

df<-dbGetQuery(con, "SELECT * FROM report_timespent_reason_stop")%>%
  arrange(-hours_rate)

### Tree map###

# define colors
col <-c(meteorite, "#9B9A9A",  lavender, orange,peridot,"#177FEB", "#733256" )  


# graph
df%>%
  hchart(
    "treemap", 
    hcaes(x = stop_reason_short, value = hours_rate))%>%

  hc_tooltip(pointFormat = "<b>{point.hours_rate:.1f}%</b> of hours are spent on <b>{point.stop_reason_short}</b> stops, or a total of {point.hours_count:,.1f} hours")%>%

 hc_plotOptions(treemap = list(colorByPoint = TRUE))%>%
                               
                               # dataLabels=list(useHTML=TRUE, format='<p class="truncate"><b>{point.stop_reason_short}</b></a>',style=list( fontSize='12px')))) %>%      
  
    hc_colors(col) %>%   #with this we can set the colors, note: 1st color is given to first row in the data frame (not necessarily the biggest box)
  
    hc_colorAxis(dataClasses = color_classes(df$stop_reason_short)) %>%      
  
  hc_title(text = "LBPD spends most of its time on traffic stops",
           align = "left") %>%
 
   hc_subtitle(text = "Hours Spent on Stops by Stop Reason",
               align = "left")%>%
  
    hc_legend(enabled = FALSE) %>%
  
  hc_caption(
      text = paste0(sourcenote)
      # , style=list(fontSize='8px')
    ) %>% 
  
      hc_add_theme(cc_theme)%>%

  
   hc_exporting(
      enabled = TRUE, sourceWidth=900, sourceHeight=600, 
      chartOptions=list(plotOptions=list(series=list(dataLabels=list(enabled=TRUE, format=paste0(list(pointFormat='{point.stop_reason_short}:<br>{point.hours_rate:.1f}% hours')))))),
      filename = paste0("Hours spent on stops by stop reason_Catalyst California, catalystcalifornia.org, 2023.")
    )
 



```


#### Time spent on traffic stops by result

```{r, echo=FALSE}

### JZ ###

#read in table

df<-dbGetQuery(con, "SELECT * FROM report_timespent_result_stop ")


# for now filter just traffic and reasonable suspicion as separate dfs

df_traffic<-df%>%
  filter(grepl('Traffic Violation',stop_reason_short))%>%
  arrange(-hours_rate)
   
  
  # mutate(hours_rate= round(hours_rate, 0))

col <-c(meteorite, lavender, orange, peridot, "#177FEB", "#733256", "#9B9A9A", "#211447",
        "#FF9E0D")


#### Item Chart 1: Traffic Stops + Results -rate of hours (/100) ####

hc<-hchart(
  df_traffic,
  "item",
  rows=8,
  tooltip = list(headerFormat="", pointFormat = "Out of 100 hours, LBPD spent <b>{point.hours_rate:.1f}</b> hours on traffic stops that resulted in <b>{point.stop_result_short}</b>"),
  hcaes(
    name = stop_result_short,
    y = hours_rate,
    label = stop_result_short,
    color = col
  ),
  name = "Total Hours",
  showInLegend = TRUE) %>%
  
  hc_title(text = "The majority of hours spent on traffic stops result in citations, warnings, or no action", 
 align="left" )%>%
  
   hc_subtitle(text = "Hours Spent on Traffic Stops by Result", 
 align="left" )%>%
  
  hc_caption(
    text = paste0(sourcenote)) %>% 
  hc_add_theme(cc_theme)%>%
  hc_exporting(
    enabled = TRUE, sourceWidth=900, sourceHeight=600, 
    chartOptions=list(plotOptions=list(series=list(dataLabels=list(enabled=TRUE, format=paste0(list(pointFormat='{point.hours_rate:.1f}')))))),
    filename = paste0("Hours Spent on Traffic Stops by Result","_Catalyst California, catalystcalifornia.org, 2023.")
  )%>%
  
  hc_legend(title=list(text='<span style="font-size: 12px; color: #000000; font-weight: bold">Single dot represents 1 hour out of 100 hours</span><br/><span style="font-size: 10px; color: #666; font-style: italic">Click to hide</span>'),
            enable = TRUE, 
            labelFormat = '{name} <span style="opacity: 0.4">{hours_rate:.1f}</span>')

# add in margins so the graph isn't cut off

hc %>%
  hc_chart(
    marginRight = 100,
    marginLeft=100
  )



```

#### Most common traffic stop citations

```{r}

# read in df

 df<-dbGetQuery(con, "SELECT * FROM report_rates_citations_race_person_long")

# convert to long format and only keep 'total' group

df_tot<-df%>%
  filter(grepl('total',race))

# df_tot<-df_tot%>%
#     mutate(Citation=ifelse(measure %in% "rank_1_label", "Unsafe speed for prevailing conditions (speeding)",
#                      ifelse(measure %in% "rank_2_label", "No vehicle or trailer registration",
#                             ifelse(measure %in% "rank_3_label", "Failure to stop at a stop sign",
#                                    ifelse(measure %in% "rank_4_label", "Failure to stop at a red light",
#                                            ifelse(measure %in% "rank_5_label", "Driver failure to obey signs/signals", 'NULL'
#                      ))))))
#    
  

# keep final rows
# df_tot<-df_tot[c(1,4,7,10,13),]


# create top citations total table (not by race)

ft<-df_tot%>%
  rename("Race"="race",
         "Citation"="label",
         "Percent"="rate",
        "Total"= "count")%>%
  select(Citation, "Percent", Total)%>%
flextable()

# add padding to title

fpp <- officer::fp_par(padding = 6,
                       line_spacing = 2
                       )

# add title 
ft <-   ft%>%set_caption(
    as_paragraph(
      as_chunk("Top five traffic citations given by LBPD",
               props = fp_text_default(font.family = main_font ))
    ), word_stylename = "Table Caption",
    fp_p = fpp)



# format number columns

ft <- colformat_double(
  x = ft,
  big.mark = ",", digits = 2, na_str = "N/A"
)

# set font and styling

ft<-font(
  ft,
  i = NULL,
  j = NULL,
  main_font,
  part = "all",
  cs.family = main_font,
  hansi.family = main_font,
  eastasia.family = main_font
)

# set width

ft<-autofit(ft)

# display

ft

```


### Stops are racially biased and disproportionately impact people of color 

Officer-initiated stops are more likely to impact people of color in Long Beach. As a part of RIPA data collection, officers are required to report the race of the person they stopped, based on the officer’s perception. The data show LBPD officers stop people they perceive as Black, Native Hawaiian or Pacific Islander (NHPI), and Middle Eastern or South Asian (MESA) at the highest rates. For example, LBPD officers stopped 169 Black people for every 1000 Black people in Long Beach. By comparison, only 61 out of every 1000 White people were stopped.  

```{r, echo=FALSE}
#### DS ####

##### Chart - stop rates per 1K by race for LB #####
#### DS ####

##### Chart - stop rates per 1K by race for LB #####
# add a comma to stop count

# Apply Chart
report_stoprates_race_person <- dbGetQuery(con, "SELECT * FROM data.report_stoprates_race_person")  %>%filter(race!="total")


fx_barbubblechart(

  db=report_stoprates_race_person, #name of dataframe

  order_var=report_stoprates_race_person$stop_rate_per1k, #variable you're sorting by

  x='race_label_short', # x or independent variables

  y='stop_rate_per1k', # y or dependent variable

  z='stop_count',

  top_finding=paste0("LBPD stopped Black, NHPI, and MESA people at higher rates than other community members."), # this is the top finding from the chart that gets used like a title

  chart_title= paste0("Number of Officer-initiated Stops per 1K of Same Population by Race and Ethnicity"), # this is the more standard chart title that gets used as a subtitle

  tooltip_text="For every 1K <b>{point.race_label_long:.1f}</b> people in Long Beach, LBPD stopped <b>{point.stop_rate_per1k:.1f}</b> people perceived as <b>{point.race_label_long:.1f}</b>, a total of <b>{point.stop_count:,0f}</b> people.", # customize your tooltip as a statement, calling out rate and count


  chart_caption = paste0(racenote,"<br>", sourcenote, "<br><br><br>"), # if necessary add a method note between the racenote and sourcenote with a line break, use racenote if graph includes data by race, and always use sourcenote. Each of these are standard objects across all charts

  yaxis_label = "''", #format for your y axis labels
   export_data_label=list(pointFormat='{point.stop_rate_per1k:.1f} per 1K')
)
```

We narrow in on traffic stops that resulted in no action to evaluate whether racial disparities in stops are connected to pretextual stops. A pretextual stop occurs when an officer has a “hunch” that a person may be connected to an illegal activity, but that “hunch” is insufficient to stop the person. To justify the stop, the officer then identifies a minor traffic violation or other infraction (i.e., “pretext”), and then subjects the person to an investigation for more serious criminal activity. Pretextual stops are a central pathway for racial profiling because those “hunches” are often based on racial biases.  

A stop that results in no action (i.e., no citation, warning, or arrest) is an indicator of pretext because if there was a serious safety risk, presumably, a citation, arrest, or other enforcement action would occur. We find that people LBPD perceived as two or more races, or as Black, were stopped at the highest rates for stops resulting in no action.^[While people perceived as MESA and AIAN have the lowest rate of traffic stops with no action, like other groups, they are no more likely to have a stop result in an arrest. Stops of people perceived as MESA are more likely to result in a citation for an infraction, but data show these citations are for traffic infractions like speeding and failing to stop at a stop sign that do not require an armed officer response.]  In   2019, over 1 in 5 traffic stops of officers perceived as Black resulted in no action. These figures are important because every additional police encounter has implications for community health and wellbeing. 

Studies show that police encounters and harassment increase anxiety and trauma among people of color, particularly Black people.^[Alang et al., Police Brutality and Black Health: Setting the Agenda for Public Health Scholars (2017) 107 Am. J. Pub. Health 662 <https://www.researchgate.net/publication/315510199_Police_Brutality_and_Black_ Health_Setting_the_Agenda_for_Public_Health_Scholars> [as of Nov. 29, 2022]] In one study in New York City, young men who reported more police contact and intrusive encounters showed higher levels of trauma and anxiety symptoms because of their experiences.^[https://scholarship.law.columbia.edu/cgi/viewcontent.cgi?article=2851&context=faculty_scholarship]  In Baltimore City following the high-profile murder of Freddie Gray, researchers found that Black residents associated the stress and fear of police harassment with community fragmentation and poor community health.^[https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4824692/pdf/11524_2015_Article_22.pdf]   Another study in New York found a significant association between more invasive pedestrian stops and the prevalence of chronic health conditions, including diabetes, high blood pressure, asthma, obesity, where neighborhoods with more invasive encounters also had poorer health outcomes.^[https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4824697/] 

```{r, echo=FALSE}

### JZ ###

# Read in table

df<-dbGetQuery(con, "SELECT * FROM report_stoprates_result_race_person")

# filter for traffic

traffic<-df%>%
  filter(grepl('Traffic Violation',reason))%>%
  filter(grepl('No Action',result))%>%
  filter(!grepl('Total',race_label_short))%>%
  arrange(desc(stop_denom_rate))

#####  Lollipop #####

# apply lollypop chart function

# Apply Chart 

fx_barbubblechart(

  db=traffic, #name of dataframe

  order_var=traffic$stop_denom_rate, #variable you're sorting by

  x='race_label_short', # x or independent variables

  y='stop_denom_rate', # y or dependent variable

  z='stop_count',

  top_finding=paste0("LBPD is most likely to stop Multiracial and Black people for minor traffic stops"), # this is the top finding from the chart that gets used like a title

  chart_title= paste0("Percent of Traffic Stops that Resulted in No Action by Race"), # this is the more standard chart title that gets used as a subtitle

 
  tooltip_text="<b>{point.stop_denom_rate:,.1f}%</b> of stops of people perceived as <b>{point.race_label_short}</b> result in No Action, or a total of {point.stop_count:,.1f} stops", # customize your tooltip as a statement, calling out rate and count

  
  chart_caption = paste0(racenote,"<br>", sourcenote, "<br><br><br>"), 
  yaxis_label = "'%'", #format for your y axis labels
  export_data_label=list(pointFormat='{point.stop_denom_rate:.1f}%'))


```

```{r, echo=FALSE}


# # Read in table
# 
# df<-dbGetQuery(con, "SELECT * FROM report_stoprates_result_race_person")
# 
# # filter for traffic
# 
# traffic<-df%>%
#   filter(grepl('Traffic Violation',reason))%>%
#   filter(grepl('No Action|Warning',result))%>%
#   filter(!grepl('Total',race_label_short))
# 
# 
# # set order of grouped bars
# 
# traffic <- within(traffic, result <- factor(result, levels=c("Warning","No Action")))
# 
# # set color levels custom
# 
# color <-  c(meteorite, orange)
# 
# 
# traffic%>%
#   arrange(desc(result))%>%
#   hchart("lollipop", invert = TRUE,
#          hcaes(x=race_label_short,
#                y=stop_pop_rate,
#                group=result),
#          color=color)%>%
#   hc_xAxis( title = list(text = "") ) %>% 
#   
#   hc_yAxis( title = list(text = ""),
#             labels = list(format = "{value}%")) %>%  
#   
#   # title elements
#   hc_title(
#     text = paste0("Black drivers are most likely to be stopped for minor traffic stops"),
#     #margin = 20,
#     align = "left", 
#     style = list(useHTML = TRUE
#     )
#   ) %>% 
#   hc_plotOptions(series=list(connectorWidth=1.2,
#                              marker=list(symbol='circle')))%>%
#   hc_subtitle(
#     text = paste0("Rate of traffic stops that resulted in a warning no action by race"), align="left"
#   ) %>% 
#   hc_caption(
#     text = paste0(racenote,"<br>", sourcenote)
#   ) %>% 
#   hc_add_theme(cc_theme)%>%
#   hc_chart(inverted = T) %>%
#   hc_exporting(
#     enabled = TRUE, sourceWidth=900, sourceHeight=600, 
#     chartOptions=list(plotOptions=list(series=list(dataLabels=list(enabled=TRUE, format=paste0(list(pointFormat='{point.stop_pop_rate:.1f}%')))))),
#     filename = paste0("Rate of traffic stops that resulted in a warning no action by race","_Catalyst California, catalystcalifornia.org, 2023.")
#   )
# 
# 

```


## LBPD unjustly targets low-income   communities of color with unnecessary stops.  

We also analyze variations in where LBPD officer-initiated stops occur to understand how stops differ across communities. We map the approximate location of officer-initiated stops by council district, race, and result based on location information. 

First, we show how stops are distributed across council districts in relationship to race.  Then we look at how the results of officer-initiated stops vary by district. The data show that council districts with higher concentrations of people of color experienced the highest stop rates across council districts. Specifically, council districts in the West side of Long Beach, which includes districts 1, 6, and 7, had the highest number of stops and stop rates. These council districts also have higher concentrations of people of color and lower median incomes compared to the east side of Long Beach.^[https://la.myneighborhooddata.org/2019/02/employment-inequality-across-long-beach-city/]  

Higher stop rates in a district does not translate to a greater likelihood of stops resulting in an enforcement action (e.g., citation, arrest, etc.). In districts with a higher concentration of people of color and more stops, LBPD is more likely to spend time on stops with no action. For instance, the East side of Long Beach, which consists of districts 3,4, and 5, had lower overall stops, but police spent a lower percentage of hours on stops with no action compared to other districts. Districts 3, 4, and 5 coincide to areas in the city with a higher concentration of White people and higher median income. 


### People of color are stopped at higher rates across council districts.  {.tabset .tabset-pills}

Across council districts, LBPD stops people of color at the highest rates.  Plotting stops by race and council districts, we find a greater density of stops of Black and Latinx people across the city. 
People LBPD perceived as Black have the highest stop rates in five out of nine council districts despite making up only a small portion of the population. For example, in Council District 3, which is in the East side of Long Beach, Black people only make up 5.6% of the population while White people make up 59% of the population; but LBPD stops people they perceive as Black at a rate 3.6 times higher than White people. In   Council District 9, Black people make up 14.5% of the population; but LBPD stops 103.8 people perceived as Black for every 1,000 Black people in the district. 

People LBPD perceived as MESA and NHPI also experience the highest rate of stops in two council districts each. LBPD stops people they perceive as NHPI at higher rates than other people in districts 6 and 8. In districts 7 and 9, they stop people perceived as MESA at the highest rates. In each of these districts, MESA and NHPI people make up a small percentage of the population but are more likely to be stopped than other community members. In Council District 9, MESA people make up only 0.7% of the population but have the highest stop rate, with a stop rate of 106.1 per 1,000 people who identify as MESA. In Council District 8, LBPD stops people perceived as NHPI at a rate of 159.7  per 1,000 people who identify as NHPI despite making up only 1% of the population in the district.

The east side region of Long Beach, consisting of council districts 3,4, and 5, have a larger White population compared to other parts of the city and have higher rates of stops for people of color. In particular, people LBPD perceived as Latinx have the second highest stop rate in Council Districts 3 & 4 and the third highest stop rate in District 5. Additionally, people LBPD perceived as Black have the highest stop rate in all of these regions. Lastly, people LBPD perceived as NHPI have the third highest stop rate in Council Districts 3  & 4 and the second highest stop rate in Council District 5. In summary, people of color, specifically people LBPD perceived as Black, NHPI, MESA, and Latinx   still end up with the highest stop rates in majority white-districts in Long Beach. 

```{r}
council_district <- st_read(con, query = "SELECT * FROM data.colb_council_districts_place_2022")
report_stoprates_cd_race_person <- st_read(con, query = "SELECT * FROM data.report_stoprates_cd_race_person")

## make council number a character file
council_district$council_num <- as.character(council_district$council_num) # change council number to character to merge

population_race_cd <-  dbGetQuery(con, "SELECT * FROM data.population_race_cd")

## merge with council district shape-file
council_district_count <-  council_district %>% 
  left_join(
    report_stoprates_cd_race_person
  ) 

# multiply rate by 100
#population_race_cd$rate <- population_race_cd$rate*100


# get demographics by council district
df_demographics <- population_race_cd %>% select(cd, race, count, rate) %>%  pivot_wider(
  names_from = race,
  names_glue = "{race}_{.value}",
  values_from = c(count:rate)
)

df_stop <- report_stoprates_cd_race_person %>% select(council_num, race, pop_count, stop_count, stop_rate_per1k) %>%  pivot_wider(
 names_from = race,
 names_glue = "{race}_{.value}",
 values_from = c(pop_count:stop_rate_per1k)
)

## merge df_demographics with council_district-- get council_district_demographics
council_district_demographics <- council_district %>% 
  left_join(
    df_demographics, by = c("council_num" = "cd")
  ) 

## merge with stop rate

council_district_demographics <- council_district_demographics %>% left_join(df_stop)
## only keep last name of rep
####council_district_rate <- council_district_rate %>% mutate(representat = gsub(".* ", "", representat))


# convert to scattered dots for plotting
lb_ripa_dots = as_dot_density(
  council_district_count,
  value = "stop_count",
  values_per_dot = 10, ## each dot represents 10
  group = "race"
)

## filter for race groups
nh_black_dots <- lb_ripa_dots %>% filter(race == "nh_black")
nh_white_dots <- lb_ripa_dots %>% filter(race == "nh_white")
aian_dots <- lb_ripa_dots %>%  filter(race == "aian")
latinx_dots <- lb_ripa_dots %>% filter(race == "latinx")
mesa_dots <- lb_ripa_dots %>% filter(race == "mesa")
nh_asian_dots <- lb_ripa_dots %>% filter(race == "nh_asian")
nh_twoormor_dots <- lb_ripa_dots %>% filter(race == "nh_twoormor")
nhpi_dots <- lb_ripa_dots %>% filter(race == "nhpi")


## function to change the legend shape and color
colors_function <- function(colors, sizes, borders, shapes) {
  shapes <- gsub("circle", "100%", shapes)
  shapes <- gsub("square", "100%", shapes)
  paste0(colors, "; width:", sizes, "px; height:", sizes, "px; border:1px solid ", borders, "; border-radius:", shapes)
}


###



### Pop-ups ### ---------------
#create popup
demographic_popup <- paste0("<div class='pointdensity'> <div class='leaflet-data' data-cd='",council_district_demographics$council_num,
               "' data-nh-black-stop-rate='",council_district_demographics$nh_black_stop_rate,
               "' data-nh-black-rate='",scales::percent(council_district_demographics$nh_black_rate, accuracy = 0.1),
               "' data-latinx-stop-rate='",council_district_demographics$latinx_stop_rate,
               "' data-latinx-rate='",scales::percent(council_district_demographics$latinx_rate, accuracy = 0.1),
               "' data-nh-asian-stop-rate='",council_district_demographics$nh_asian_stop_rate,
               "' data-nh-asian-rate='",scales::percent(council_district_demographics$nh_asian_rate, accuracy = 0.1),
               "' data-nh-white-stop-rate='",council_district_demographics$nh_white_stop_rate,
               "' data-nh-white-rate='",scales::percent(council_district_demographics$nh_white_rate, accuracy = 0.1),
               "' data-mesa-stop-rate='",council_district_demographics$mesa_stop_rate,
               "' data-mesa-rate='",scales::percent(council_district_demographics$mesa_rate, accuracy = 0.1),
               "' data-nhpi-stop-rate='",council_district_demographics$nhpi_stop_rate,
               "' data-nhpi-rate='",scales::percent(council_district_demographics$nhpi_rate, accuracy = 0.1),
               "' data-aian-stop-rate='",council_district_demographics$aian_stop_rate,
               "' data-aian-rate='",scales::percent(council_district_demographics$aian_rate, accuracy = 0.1),
               "' data-nh-twoormor-stop-rate='",council_district_demographics$nh_twoormor_stop_rate,
               "' data-nh-twoormor-rate='",scales::percent(council_district_demographics$nh_twoormor_rate, accuracy = 0.1),
               "' ></div></div>")


# colors according to our brand guide: https://catalystcalifornia.sharepoint.com/sites/Portal/AP%20Projects/Forms/AllItems.aspx?FolderCTID=0x012000EF0283621C7FE048A8E68512F119353B&id=%2Fsites%2FPortal%2FAP%20Projects%2FCommunications%2FCatalyst%20California%2FBranding%20Materials%20%2B%20Templates%2FVisual%20Brand%20Guide%2FCatalyst%20California%20Brand%20Guide%5FSeptember%202022%2Epdf&viewid=1aaeb4a9%2D2232%2D41c7%2Da71c%2D727af9e1f5d7&parent=%2Fsites%2FPortal%2FAP%20Projects%2FCommunications%2FCatalyst%20California%2FBranding%20Materials%20%2B%20Templates%2FVisual%20Brand%20Guide

# Base Color 00
lime_green <- c('#0AB013')
persian_indigo <- c('#211447')
halloween_orange <- c('#DF4007')
bitter_lemon <- c('#BCD313')
blue <- c('#0860BC')
#dark_tangerine <- c('#EB8D00')
american_yellow <- c('#EABB00')
halaya_ube <- c('#601D42')
dark_silver <- c('#6F6F6F') 



### change size of legend

 leaflet(width = "100%", height = "600px",
        options = leafletOptions(zoomControl = FALSE)) %>%
   
   # create sidebar and add html for content
addControl(html="<div class='leaflet-popup-scrolled point-density-sidebar'><div class ='cd-header' style='margin-bottom: 8px; margin-top: 8px; font-weight: 800; font-size: 14px;'>Council District <span class='cd' style='font-weight: 800; font-size: 14px;'></span></div><span style='color: #000000; font-weight: 400;line-height: 1em;'>LBPD stopped <span class='nh-black-stop-rate nh-black-color'></span> <span class='nh-black-color'>Black people per 1K Black people.</span> They are <span class='nh-black-rate'></span> of CD<span class='cd'></span>'s population.<br><div style='width: 100%;'><div class=rate-bar></div><div class=count-bubble></div></div><span style='color: #000000; font-weight: 400;line-height: 1em;'>LBPD stopped <span class='latinx-stop-rate latinx-color'></span> <span class='latinx-color'>Latinx people per 1K Latinx people.</span> They are <span class='latinx-rate'></span> of CD<span class='cd'></span>'s population.<br><span style='color: #000000; font-weight: 400;line-height: 1em;'>LBPD stopped <span class='nh-asian-stop-rate nh-asian-color'></span> <span class='nh-asian-color'>Asian people per 1K Asian people.</span> They are <span class='nh-asian-rate'></span> of CD<span class='cd'></span>'s population.<br><span style='color: #000000; font-weight: 400;line-height: 1em;'>LBPD stopped <span class='nh-white-stop-rate nh-white-color'></span> <span class='nh-white-color'>White people per 1K White people.</span> They are <span class='nh-white-rate'></span> of CD<span class='cd'></span>'s population.<br><span style='color: #000000; font-weight: 400;line-height: 1em;'>LBPD stopped <span class='mesa-stop-rate mesa-color'></span> <span class='mesa-color'>MESA people per 1K MESA people.</span> They are <span class='mesa-rate'></span> of CD<span class='cd'></span>'s population.<br><span style='color: #000000; font-weight: 400;line-height: 1em;'>LBPD stopped <span class='nhpi-stop-rate nhpi-color'></span> <span class='nhpi-color'>NHPI people per 1K NHPI people.</span> They are <span class='nhpi-rate'></span> of CD<span class='cd'></span>'s population.<br><span style='color: #000000; font-weight: 400;line-height: 1em;'>LBPD stopped <span class='aian-stop-rate aian-color'></span> <span class='aian-color'>AIAN people per 1K AIAN people.</span> They are <span class='aian-rate'></span> of CD<span class='cd'></span>'s population.<br><span style='color: #000000; font-weight: 400;line-height: 1em;'>LBPD stopped <span class='nh-twoormor-stop-rate nh-twoormor-color'></span> <span class='nh-twoormor-color'>people of Two Or More Races per 1K people of Two or More Races.</span> They are <span class='nh-twoormor-rate'></span> of CD<span class='cd'></span>'s population.<br><span style='font-size: 10px; font-style: italic;'>*Each dot represents 10 people stopped by LBPD.</span></div>", position = "topleft") %>%

    ### add latinx dots
  
 addCircleMarkers(data = latinx_dots, group = "Latinx", label = NULL, weight = 2, fillOpacity = 1, radius = 2, color="white",  fillColor= lime_green,  stroke = TRUE) %>% 
   
  ## add NH Black Stops
  
addCircleMarkers(data = nh_black_dots, group = "Black", label = NULL, weight = 2, fillOpacity = 1, radius = 2, color="white",  fillColor=blue, stroke = TRUE) %>% 
   
   ### add nh asian dots
  
 addCircleMarkers(data = nh_asian_dots, group = "Asian", label = NULL, weight = 2, fillOpacity = 1, radius = 2, color="white",  fillColor=  halloween_orange, stroke = TRUE) %>% 
   
  
  ## add NH White Stops
  
 addCircleMarkers(data = nh_white_dots, group = "White", label = NULL, weight = 2, fillOpacity = 1, radius = 2, color="white",  fillColor=  bitter_lemon,  stroke = TRUE) %>% 
   
    ### add MESA dots
  
 addCircleMarkers(data = mesa_dots, group = "MESA", label = NULL, weight = 2, fillOpacity = 1, radius = 2, color="white",  fillColor= american_yellow, stroke = TRUE) %>% 
  
  
   ### add nhpi dots
  
 addCircleMarkers(data = nhpi_dots, group = "NHPI", label = NULL, weight = 2, fillOpacity = 1, radius = 2, color="white",  fillColor= halaya_ube, stroke = TRUE) %>% 
   
  ### add AIAN dots 
  
 addCircleMarkers(data = aian_dots,  group = "AIAN", label = NULL, weight = 2, fillOpacity = 1, radius = 2, color="white",  fillColor= dark_silver, stroke = TRUE) %>% 
  
  ### add nh two or more dots
  
 addCircleMarkers(data = nh_twoormor_dots, group = "Two or More Races", label = NULL, weight = 2, fillOpacity = 1, radius = 2, color="white",  fillColor= persian_indigo, stroke = TRUE) %>% 
  

  
   # add Long beach district layer with stop rates
  addPolygons(data = council_district_demographics, label=~htmlEscape(paste0("Council District ", council_num)), color = "black", fillColor = "white", opacity = 1,  popup = ~paste0(demographic_popup), 
            weight = 2, smoothFactor = 0.5,  highlight = highlightOptions(color = "white", weight = 3, bringToFront = TRUE, sendToBack = FALSE)) %>%
  
  addLayersControl(overlayGroups = c("Latinx","Black",  "Asian", "White",  "MESA", "NHPI", "AIAN", "Two or More Races"),
                   options = layersControlOptions(collapsed = FALSE),
                   position = 'topright')  %>%
  
  #base and view
  
  addProviderTiles("CartoDB.Positron")%>%
  setView(-118.16675, 	33.80462	, zoom = 12) %>% #base and view 
  
  hideGroup(c("White"))  %>% # hide white group
 
 
  # move location control to top right
  htmlwidgets::onRender("function(el, x) {
        L.control.zoom({position: 'bottomright'}).addTo(this)
    }")

 
 #<span style=' font-size: 12px;'>Race/ethnicity: AIAN=American Indian or Alaska Native, NHPI=Native Hawaiian or Pacific Islander, MESA=Middle Eastern or South Asian; Observations by race may overlap in the point density map.</span style>

#<span style='float: left; font-size: 12px;'>Catalyst California's calculations based on City of Long Beach's Police Stop Data (2019); <u>[Catalyst California](https://www.catalystcalifornia.org)</u>, 2023.</span style>

```
<style type="text/css">

.info {
    border-radius: 0;
}
<!-- .point-density-sidebar { -->
<!--     width:600px; -->
<!--     opacity:  1; -->
<!--     border-left:1px solid #737373; -->
<!--     border-right:1px solid #737373; -->
<!--     border-top:1px solid #737373; -->
<!--     border-bottom:1px solid #737373; -->
<!-- } -->


.nh-black-color {
  color: #0860BC;
  font-weight: 800;
}

.nh-black-rate {
  color: #000000; 
  font-weight: 400;
  line-height: 1em;
}

.latinx-color {
  color: #0AB013;
  font-weight: 800;
}

.latinx-rate {
  color: #000000; 
  font-weight: 400;
  line-height: 1em;
}

.nh-asian-color {
  color: #DF4007;
  font-weight: 800;
}

.nh-asian-rate {
  color: #000000; 
  font-weight: 400;
  line-height: 1em;
}

.nh-white-color {
  color: #BCD313;
  font-weight: 800;
}

.nh-white-rate {
  color: #000000; 
  font-weight: 400;
  line-height: 1em;
}

.mesa-color {
  color: #EABB00;
  font-weight: 800;
}

.mesa-rate {
  color: #000000; 
  font-weight: 400;
  line-height: 1em;
}

.nhpi-color {
  color: #601D42;
  font-weight: 800;
}

.nhpi-rate {
  color: #000000; 
  font-weight: 400;
  line-height: 1em;
}

.aian-color {
  color: #6F6F6F;
  font-weight: 800;
}

.aian-rate {
  color: #000000; 
  font-weight: 400;
  line-height: 1em;
}

.nh-twoormor-color {
  color: #211447;
  font-weight: 800;
}

.nh-twoormor-rate {
  color: #000000; 
  font-weight: 400;
  line-height: 1em;
}

<!-- .leaflet-touch .leaflet-control-layers { -->
<!--   border-left:1px solid #737373; -->
<!--     border-right:1px solid #737373; -->
<!--     border-top:1px solid #737373; -->
<!--     border-bottom:1px solid #737373; -->
<!-- } -->

.leaflet-popup-scrolled {
  height: 600px;
  overflow: auto;
  opacity: 1;
  border-bottom: 0;
  border-top: 0;
}

.info {
  background: white;
  opacity: 1;
}

.leaflet-left {
  width: 300px;
}

.leaflet-left .leaflet-control {
  margin-left: 0;
  border-left: 1px solid #ddd;
  border-top: 1px solid #ddd;
  border-bottom: 1px solid #ddd;
}

.leaflet-right .leaflet-control {
  margin-right: 0;
}

.leaflet-top .leaflet-control {
  margin-top: 0;
}

.leaflet-control-container {
  color: #000000;
}
<!-- .leaflet-control-layers .leaflet-control .leaflet-control-layers-expanded { -->
<!--   background-color: white; -->
<!--   opacity: 1.0; -->
<!-- } -->

.hidden {
  display: none;
}

.rate-bar {
  height: 1px;
  border: 0;
  border-top: 1px solid #0860BC;
  margin: 1em 0;
  padding: 0;
  width: 100px;
}
.count-bubble {
  position: absolute;
  width: 25px;
  height: 25px;
  border-radius: 50%;
  background-color: #0860BC;
  margin-top: -25px;
  margin-left:100px;
  
}
</style>
```{js}
<!-- This function is used to format LB RIPA data in the point density map "popup"/sidebar feature -->

<!-- Captures  -->
var mapsPlaceholder = [];
L.Map.addInitHook(function () {
  mapsPlaceholder.push(this);
  mapsPlaceholder.forEach(map => {
    map.on('popupopen', (e) => {
    
    let popups = document.querySelectorAll('.leaflet-data');
    console.log(popups);

document.querySelectorAll('.pointdensity').forEach(pointdensity => {
pointdensity.parentElement.parentElement.parentElement.classList.add('hidden')
})
  
popups.forEach((popup) => {
console.log(popup)
console.log(popup.getAttribute('data-cd').trim())

document.querySelector('.cd').innerHTML = popup.getAttribute('data-cd')
document.querySelector('.nh-black-stop-rate').innerHTML = popup.getAttribute('data-nh-black-stop-rate')
document.querySelector('.nh-black-rate').innerHTML = popup.getAttribute('data-nh-black-rate')
document.querySelector('.latinx-stop-rate').innerHTML = popup.getAttribute('data-latinx-stop-rate')
document.querySelector('.latinx-rate').innerHTML = popup.getAttribute('data-latinx-rate')
document.querySelector('.nh-asian-stop-rate').innerHTML = popup.getAttribute('data-nh-asian-stop-rate')
document.querySelector('.nh-asian-rate').innerHTML = popup.getAttribute('data-nh-asian-rate')
document.querySelector('.nh-white-stop-rate').innerHTML = popup.getAttribute('data-nh-white-stop-rate')
document.querySelector('.nh-white-rate').innerHTML = popup.getAttribute('data-nh-white-rate')
document.querySelector('.mesa-stop-rate').innerHTML = popup.getAttribute('data-mesa-stop-rate')
document.querySelector('.mesa-rate').innerHTML = popup.getAttribute('data-mesa-rate')
document.querySelector('.nhpi-stop-rate').innerHTML = popup.getAttribute('data-nhpi-stop-rate')
document.querySelector('.nhpi-rate').innerHTML = popup.getAttribute('data-nhpi-rate')
document.querySelector('.aian-stop-rate').innerHTML = popup.getAttribute('data-aian-stop-rate')
document.querySelector('.aian-rate').innerHTML = popup.getAttribute('data-aian-rate')
document.querySelector('.nh-twoormor-stop-rate').innerHTML = popup.getAttribute('data-nh-twoormor-stop-rate')
document.querySelector('.nh-twoormor-rate').innerHTML = popup.getAttribute('data-nh-twoormor-rate')

// Rescaling function: (((oldValue - oldMin) * (newMax - newMin)) / (oldMax - oldMin)) + newMin
let rateScaled = (((stopRate - 3.5) * (275 - 5)) / (512.1 - 3.5)) + 5
let countScaled = (((popCount - 6) * (50 - 10)) / (3283 - 6)) + 10
})})})})

```
<span style=' font-size: 12px;'>Race/ethnicity: AIAN=American Indian or Alaska Native, NHPI=Native Hawaiian or Pacific Islander, MESA=Middle Eastern or South Asian; Observations by race may overlap in the point density map. </span> 
<br> <span style=' font-size: 12px;'>Catalyst California's calculations based on City of Long Beach's Police Stop Data (2019); <u>[Catalyst California](https://www.catalystcalifornia.org)</u>, 2023. Analysis for all officer-initiated stops.</span>


### More hours are spent on unnecessary stops in communities of color

Higher stop rates in communities do not necessarily translate to a higher likelihood of detecting serious crimes. We calculate the percent of hours LBPD spends on officer-initiated stops that resulted in no action (e.g. no citation, warning, or arrest) in each council district. These officer-initiated stops waste public resources that could be invested in more effective and equitable approaches to community safety.       

Council districts 1, 9, 6, and 8 have  higher rates of stops that result in no action (i.e., no citation, arrest, etc.). Council districts 8 and 9 have a large concentration of residents who identify as Latinx and Black. These districts are located in the North side of Long Beach and have a lower median income compared to the East side of the city based on data from the Neighborhood Data for Social Change (NDSC).^[“Although the 2016 median family income for the City of Long Beach was $55,151 – relatively similar to the county average – income levels varied greatly across the city’s census tracts. In the west side of the city, median household income levels were as low as $11,736. Meanwhile, median household income levels were as high as $122,526 in the east side of the city, a difference more than 10 times the other.” Neighborhood Data for Social Change (NSDC). (n.d.). Addressing Employment Inequality in the City of Long Beach. Retrieved from https://la.myneighborhooddata.org/2019/02/employment-inequality-across-long-beach-city/] The east side region of Long Beach, consisting of council districts 3, 4, and 5, have a larger White population compared to other parts of the city and have lower rates of stops that result in no action. In these council districts, officers are spending less than 10 percent of their hours (or less than 1 in 10 hours) on officer-initiated stops on stops that result in no action compared to more than 18 percent of their hours (or almost 1 in 5 hours) on stops that result in no action in District 9. 

```{r, echo=FALSE}
#### DS ####
report_timespent_officerinitiated_cd_stop <- st_read(con, query = "SELECT * FROM report_timespent_result_cd_stop")
council_district <- st_read(con, query = "SELECT * FROM data.colb_council_districts_place_2022")

##### Map - officer initiated stops that resulted with no action  by council district #####
council_district_noaction <- council_district %>% 
    mutate(council_num=as.character(council_num))%>% 
  left_join(
    report_timespent_officerinitiated_cd_stop
  ) 
## only keep last name of rep
council_district_noaction <- council_district_noaction %>% mutate(representat = gsub(".* ", "", representat))

## add link
council_district_noaction$link <- c("https://www.longbeach.gov/district4/", "https://www.longbeach.gov/district5/","https://www.longbeach.gov/district3/","https://www.longbeach.gov/district1/","https://www.longbeach.gov/district8/","https://www.longbeach.gov/district6/","https://www.longbeach.gov/district9/","https://www.longbeach.gov/district7/","https://www.longbeach.gov/district2/")


cc_brand <- c("#E2D9FF", "#BDAFE9","#8E7ACA", "#362178","#211447")


hours_rate_noaction_cap_popup <- paste0((
label = paste0(
   "In Council District  <span style='font-size: 14px; font-weight: bold;'>",  
 council_district_noaction$council_num,"</span>"," ,officers spent <span style='font-size: 12px; font-weight: bold;'>", 
 scales::comma(council_district_noaction$hours_count_noaction_cap, accuracy = 0.1), "</span> hours in stops that resulted in no action, a rate of <span style='font-size: 14px; font-weight: bold;'> ", scales::comma(council_district_noaction$hours_rate_noaction_cap, accuracy = 0.1), "</span>%.")))



#'<a href=',  p_spdf$Link, '>', p_spdf$Link, '</a>'


#palette purples
pal_stop_hours_rate_noaction_cap <- colorQuantile(cc_brand,council_district_noaction$hours_rate_noaction_cap, n = 5)


leaflet(width = "100%", height = "600px") %>%
  # add Long beach district layer with stop rates
  addPolygons(data =  council_district_noaction,  label=~htmlEscape(paste0("Council District ", council_num)), color = "black", weight = 2, smoothFactor = 0.5, opacity = 1, fillOpacity = 0.5, popup = ~paste0(hours_rate_noaction_cap_popup),
              fillColor = ~pal_stop_hours_rate_noaction_cap(hours_rate_noaction_cap), highlight = highlightOptions(color = "white", weight = 3, bringToFront = TRUE, sendToBack = FALSE), group = "") %>%
  
  ## add legend for stop hours
  addLegend(position = "bottomleft", pal = pal_stop_hours_rate_noaction_cap, values = council_district_noaction$hours_rate_noaction_cap, opacity = .5, title = "Percent of Hours Spent on Stops with No Action", na.label = NA, labFormat = function(type, cuts, p) {
    n = length(cuts)
    paste0(scales::comma(cuts, accuracy = .1)[-n], " &ndash; ", scales::comma(cuts, accuracy = .1)[-1], "%")
  }) %>%

  
  #base and view
  
  addProviderTiles("CartoDB.Positron")%>%
  setView(-118.16675, 	33.80462	, zoom = 12) #base and view 
  
```
<span style=' font-size: 12px;'>Catalyst California's calculations based on City of Long Beach's Police Stop Data (2019); <u>[Catalyst California](https://www.catalystcalifornia.org)</u>, 2023. Analysis for all officer-initiated stops.</span>


## Traffic stops are an inefficient means of advancing safety and pose a greater burden on people of color

A common narrative may be that traffic stops lead to safer streets with fewer injuries and less crime. In reality, communities of color are often the communities with higher rates of injuries from traffic collisions and profiling by police. Comparing traffic collisions to traffic stops shows officer-initiated stops do not necessarily make roadways safer nor do they correlate to areas with higher risk of road injuries. These stops are also ineffective in preventing serious crime. LBPD overwhelming conducts unnecessary searches of people through traffic stops, finding nothing of consequence. People of color bare the largest impact of these stops.

### Traffic stops do not correlate to safer streets for communities impacted traffic injuries.

A common narrative is that traffic stops and police presence are necessary for safety in our communities and roadways. In reality, built environment and street design improvements can be a more effective means for traffic safety and do not expose communities of color to unnecessary contact with law enforcement. 

Traffic stops and police presence increase trauma for communities of color already disproportionately impacted by traffic injuries. Police presence alone can heighten feelings of anxiety among people of color, specifically Black people, and increased interactions with police are associated with heightened symptoms of anxiety and trauma.^[https://oag.ca.gov/system/files/media/ripa-board-report-2023.pdf https://scholarship.law.columbia.edu/cgi/viewcontent.cgi?article=2851&context=faculty_scholarship https://repository.law.umich.edu/cgi/viewcontent.cgi?article=1293&context=mjrl]  Analysis of police stop data routinely shows that traffic stops of people of color are less likely to lead to evidence of a crime and people of color are overrepresented in stops that lead to no enforcement.^[https://www.ppic.org/publication/racial-disparities-in-law-enforcement-stops/]  And while communities of color are disproportionately burdened by unnecessary police stops and traffic injuries, they often have worse street design and conditions that undermine safety for pedestrians.^[ https://bridgingthegap.ihrp.uic.edu/_asset/02fpi3/btg_street_walkability_FINAL_03-09-12.pdf]

Data show that such trends prove true in Long Beach. Specifically, we map stop rates for traffic violations by council district and high-injury networks for motor vehicles, pedestrians, and bikes. We also analyze the hit rate, or percentage of searches among traffic stops that yield evidence or contraband, by race. The data show that traffic stops are concentrated in low-income communities of color most impacted by high-injury networks. Data also show that people of color are also most impacted by unnecessary searches made by LBPD.


```{r, echo=FALSE}
#### DS ####

high_injury_motor_corridors_line_sf <- st_read(con, query = "SELECT * FROM data.high_injury_motor_corridors_spatial") %>% st_as_sf()
high_injury_motor_intersections_spdf <- st_read(con, query = "SELECT * FROM data.high_injury_motor_intersections_spatial")
high_injury_ped_corridors_line_sf  <- st_read(con, query = "SELECT * FROM data.high_injury_ped_corridors_spatial")  %>% st_as_sf()
high_injury_ped_intersections_spdf <- st_read(con, query = "SELECT * FROM data.high_injury_ped_intersections_spatial")
report_traffic_stoprates_cd_race_person <- dbGetQuery(con, "SELECT * FROM data.report_traffic_stoprates_cd_race_person") 
 

##### Map - map comparing traffic stop rates to injury networks #####
#source("W:/Project/ECI/LB RIPA/R/3. Safety/report_highinjury_corridors_intersections.R")

# merge stop rates by council district shape-file -----------------------------------
council_district$council_num <- as.character(council_district$council_num) # change council number to character to merge

df <- report_traffic_stoprates_cd_race_person %>% select(council_num, race, pop_count, traffic_stop_count, traffic_stop_rate) %>%  pivot_wider(
  names_from = race,
  names_glue = "{race}_{.value}",
  values_from = c(pop_count:traffic_stop_rate)
)

## get traffic stop rate by council number
council_district$council_num <- as.character(council_district$council_num)

# merge
council_district_traffic_rate <- council_district %>% 
  left_join(
    df
  ) 

## only keep last name of rep
#council_district_traffic_rate <- council_district_traffic_rate %>% mutate(representat = gsub(".* ", "", representat))


council_district_traffic_rate$link <- c("https://www.longbeach.gov/district4/", "https://www.longbeach.gov/district5/","https://www.longbeach.gov/district3/","https://www.longbeach.gov/district1/","https://www.longbeach.gov/district8/","https://www.longbeach.gov/district6/","https://www.longbeach.gov/district9/","https://www.longbeach.gov/district7/","https://www.longbeach.gov/district2/")

### remove Long Beach, CA from pop-up

high_injury_motor_intersections_spdf <- high_injury_motor_intersections_spdf  %>% mutate(address= gsub(", Long Beach, CA, USA", "", address))
high_injury_ped_intersections_spdf <- high_injury_ped_intersections_spdf  %>% mutate(address= gsub(", Long Beach, CA, USA", "", address))
high_injury_motor_corridors_line_sf <- high_injury_motor_corridors_line_sf %>% mutate(address_1= gsub(", Long Beach, CA, USA", "", address_1),
                                                                   address_2= gsub(", Long Beach, CA, USA", "", address_2),)
high_injury_ped_corridors_line_sf <- high_injury_ped_corridors_line_sf  %>% mutate(address_1= gsub(", Long Beach, CA, USA", "", address_1),
                                                                   address_2= gsub(", Long Beach, CA, USA", "", address_2),)



###############
####Pop-Ups####
###############

high_injury_motor_intersections_popup <- paste0((
  label = paste0(
    "There were approximately <span style='font-weight: bold;'>", high_injury_motor_intersections_spdf$num_killed_or_seriously_injured, "</span> killed or seriously injured, <span style='font-size: 12px; font-weight: bold;'>",  
    high_injury_motor_intersections_spdf$num_vehicle_crashes, "</span> vehicle crash(es), and <span style='font-size: 12px; font-weight: bold;'>", high_injury_motor_intersections_spdf$num_motorcycle_crashes,"</span> motorcycle crash(es) at the intersection of <span style='font-size: 12px; font-weight: bold;'>",  
    high_injury_motor_intersections_spdf$address,".")))


high_injury_ped_corridors_popup <- paste0((
  label = paste0(
    "There were approximately <span style='font-weight: bold;'>", high_injury_ped_corridors_line_sf$num_killed_or_seriously_injured, "</span> killed or seriously injured and <span style='font-size: 12px; font-weight: bold;'>",  
    high_injury_ped_corridors_line_sf$num_crashes, "</span> pedestrian or bicycle crash(es), at corridor <span style='font-size: 12px; font-weight: bold;'>",
    high_injury_ped_corridors_line_sf$corridor, "</span>. This corridor runs from <span style='font-size: 12px; font-weight: bold;'>", high_injury_ped_corridors_line_sf$address_1, "</span> to <span style='font-size: 12px; font-weight: bold;'>", high_injury_ped_corridors_line_sf$address_2, ".")))






high_injury_motor_corridors_popup <- paste0((
  label = paste0(
    "There were approximately <span style='font-weight: bold;'>", high_injury_motor_corridors_line_sf$num_killed_or_seriously_injured, "</span> killed or seriously injured and <span style='font-size: 12px; font-weight: bold;'>",  
    high_injury_motor_corridors_line_sf$num_crashes, "</span> vehicle or motorcycle crash(es), at corridor <span style='font-size: 12px; font-weight: bold;'>",
    high_injury_motor_corridors_line_sf$corridor, "</span>. This corridor runs from <span style='font-size: 12px; font-weight: bold;'>", high_injury_motor_corridors_line_sf$address_1, "</span> to <span style='font-size: 12px; font-weight: bold;'>", high_injury_motor_corridors_line_sf$address_2,".")))




high_injury_ped_intersections_popup <- paste0((
  label = paste0(
    "There were approximately <span style='font-weight: bold;'>", high_injury_ped_intersections_spdf$num_killed_or_seriously_injured, "</span> killed or seriously injured, <span style='font-size: 12px; font-weight: bold;'>",  
    high_injury_ped_intersections_spdf$num_ped_crashes, "</span> pedestrian crash(es), and <span style='font-size: 12px; font-weight: bold;'>", high_injury_ped_intersections_spdf$num_bike_crashes,"</span> bike crash(es) at the intersection of <span style='font-size: 12px; font-weight: bold;'>",  
    high_injury_ped_intersections_spdf$address,".")))


#### traffic stop rate pop_up ####

total_traffic_rate_popup <- paste0((
 label = paste0(
    "For every 1K <span style='font-weight: bold;'>Total</span> people in Council District <span style='font-size: 12px; font-weight: bold;'>",  council_district_traffic_rate$council_num, "</span>", ", LBPD stopped <span style='font-size: 12px; font-weight: bold;'>",council_district_traffic_rate$total_traffic_stop_rate, "</span>  people, a total of <span style='font-size: 12px; font-weight: bold;'> ", scales::comma(council_district_traffic_rate$total_traffic_stop_count), "</span> people. ")))
  
  


## palette #2

#cc_brand2 <- c('#FFbDA6', '#FF9873', '#FA7B4D', '#F25922', '#DF4007')

#palette colors for dots/lines

papaya_orange <- c("#DF4007")
american_yellow <- c("#EABB00")

#peridot <- c("#CEEA01")

cc_brand <- c("#E2D9FF", "#BDAFE9","#8E7ACA", "#362178","#211447")

pal_total <- colorQuantile(cc_brand, council_district_traffic_rate$total_traffic_stop_rate, n = 5)

## function to change the legend shape and color

#colors_function_circle <- function(colors, sizes, borders, shapes) {
 # shapes <- gsub("circle", "100%", shapes)
 # paste0(colors, "; width:", sizes, "px; height:", sizes, "px; border:1px solid ", borders, "; border-radius:", shapes)
#}



leaflet(width = "100%", height = "600px") %>%
  
  
  # add Long beach district layer with stop rates
  addPolygons(data = council_district_traffic_rate,  label=~htmlEscape(paste0("Council District ", council_num)), color = "#444444", weight = 2, smoothFactor = 0.5,  opacity = 1, fillOpacity = 0.5,  fillColor = ~pal_total(total_traffic_stop_rate),
              popup = ~paste0(total_traffic_rate_popup), highlight = highlightOptions(color = "white", weight = 3, bringToFront = FALSE), group = "Council Districts") %>%
  
  ## add motor corridors 
  addPolylines(data = high_injury_motor_corridors_line_sf, group = "High Injury Motor Intersections/Corridors",
               popup= ~paste0(high_injury_motor_corridors_popup),
               label= ~htmlEscape(paste0("High Injury Motor Intersections/Corridors")),
             
              color = american_yellow, weight = 2, opacity =1) %>%
  
  ## add pedestrian/bike corridors
  addPolylines(data = high_injury_ped_corridors_line_sf, group = "High Injury Pedestrian or Bike Intersections/Corridors",
               popup= ~paste0(high_injury_ped_corridors_popup),
               label= ~htmlEscape(paste0("High Injury Pedestrian or Bike Intersections/Corridors")),
              
               color = papaya_orange, weight = 2, opacity = 1) %>%
  
  
  
  ## add motor intersections
  addCircleMarkers(data = high_injury_motor_intersections_spdf, lat = ~lat, lng = ~lon,
                   group="High Injury Motor Intersections/Corridors",
                   popup= ~paste0(high_injury_motor_intersections_popup),
                   label= ~htmlEscape(paste0("High Injury Motor Vehicle/Motorcycle Intersection")),
                   weight = 2, fillOpacity = 1, radius=4,
                    color = "black", fillColor= american_yellow, stroke = TRUE
  ) %>%
  
  ## add pedestrian/bike intersections
  addCircleMarkers(data = high_injury_ped_intersections_spdf, lat = ~lat, lng = ~lon,
                   group="High Injury Pedestrian or Bike Intersections/Corridors",
                   popup= ~paste0(high_injury_ped_intersections_popup),
                   label= ~htmlEscape(paste0("High Injury Pedestrian or Bike Intersections/Corridors")),
                   weight = 2, fillOpacity = 1, radius=4,
                   color="black",  fillColor= papaya_orange, stroke = TRUE
  ) %>%
  
  
  
  ## add legend for stop rate
  addLegend(layerId = "Total", position = "bottomleft", group = "Total", pal = pal_total, values = council_district_traffic_rate$total_traffic_stop_rate, opacity = .5, title = "Traffic Stop Rate Per 1K Total Residents", na.label = NA, labFormat = function(type, cuts, p) {
    n = length(cuts)
    paste0(cuts[-n], " &ndash; ", cuts[-1])
  })  %>%
  
 #### CORRIDOR LEGEND

## add legend for corridors
##  addLegendLine(position = "bottomleft",values = 0, title = "Motor Corridors",  group = "High Injury Motor Intersections/Corridors",  baseSize = 5, width = 50, color = peridot) %>%
  
    ## add legend for corridors
#  addLegendLine(position = "bottomleft",values = 0, title = "Pedestrian or Bike Corridors",  group = "High Injury Pedestrian or Bike Intersections/Corridors",  baseSize = 5, width = 50, color = papaya_orange) %>%
  
  ### PEDESTRIAN LEGEND
  
  ## add legend for intersections
#   addLegend(position = "bottomleft",   title = "", group = "High Injury Pedestrian or Bike Intersections/Corridors", labels = "Pedestrian or Bike Intersections", colors = colors_function_circle(colors =papaya_orange, sizes = "10", shapes = "circle", borders = NULL) ) %>%
  

 #  addLegend(position = "bottomleft",   title = "", group = "High Injury Motor Intersections/Corridors", labels = "Motor Intersections", colors = colors_function_circle(colors =peridot, sizes = "10", shapes = "circle", borders = NULL) ) %>%
  
  
  #layer control
  
  addLayersControl(overlayGroups =  
                     c("High Injury Motor Intersections/Corridors", "High Injury Pedestrian or Bike Intersections/Corridors"), 
                   options = layersControlOptions(collapsed = FALSE)) %>%  
  
  #  htmlwidgets::onRender("
  #     function() {
  #         $('.leaflet-control-layers-list').prepend('<label style=\"text-align:center\">High Injury Corridors and Intersections</label>');
  #      }
  #  ") %>%
  
  #base and view
  
  addProviderTiles("CartoDB.Positron") %>%
  setView(-118.16675, 	33.80462	, zoom = 12) %>% #base and view 
  
  hideGroup(c("Pedestrian/Bike"))
```
<span style=' font-size: 12px;'>Catalyst California's calculations based on City of Long Beach's Police Stop Data (2019); <u>[Catalyst California](https://www.catalystcalifornia.org)</u>, 2023. Analysis for all officer-initiated stops for traffic violations.</span>



### Low-income communities of color are dually impacted by traffic stops and traffic injuries

Low-income communities and people of color are overrepresented in victims of traffic collisions based on research in Los Angeles and nationally.  In Long Beach, we compare 2019 traffic stops to high-injury corridors and intersections identified by the Safe Streets Long Beach initiative in 2013-17 to examine how communities of color are being impacted both by the burden of law enforcement stops and traffic injuries.^[The initiative identified these high-injury corridors and intersections based on 2013-17 data, but they remain the initiative’s action plan to guarantee equity in increasing road safety.]

Council districts 1 and 6 have the highest number of high-injury corridors and highest rate of officer-initiated traffic stops. These districts also have high shares of people of color and coincide with areas in Long Beach that have lower median incomes.^[https://la.myneighborhooddata.org/2019/02/employment-inequality-across-long-beach-city/]  Notably, council districts 3, 4, and 5, the districts with the lowest percentages of people of color have fewer high-injury pedestrian or bike corridors. In other words, low-income communities of color in Long Beach are disproportionately impacted by traffic injuries and police stops. Public investments in traffic safety should be made based on the needs and priorities of these communities. Research has shown that more police stops do not reduce traffic injuries or fatalities. Based on data across 33 states, the National Institute of Health found no significant association between police stops and vehicle collision death rates.^[https://catalyst-ca.cdn.prismic.io/catalyst-ca/126c30a8-852c-416a-b8a7-55a90c77a04e_APCA+ACLU+REIMAGINING+COMMUNITY+SAFETY+2022_5.pdf] 

Prior research and recommendations from transportation practitioners underscore how traffic safety can be increased without the additional trauma of police interactions. In Seattle, reducing speeds and increasing sign density lowered speeds and led to fewer crashes in the city.^[https://www.seattle.gov/Documents/Departments/SDOT/VisionZero/SpeedLimit_CaseStudies_Report.pdf]  And while street design can help with pedestrian safety, communities of color and low-income communities are less likely to have features of street design known to help with pedestrian safety.^[https://bridgingthegap.ihrp.uic.edu/_asset/02fpi3/btg_street_walkability_FINAL_03-09-12.pdf]  Highway siting decisions, traffic engineering practices, and other street design decisions can also result in substandard, dangerous streets for communities of color.^[https://nacto.org/wp-content/uploads/2020/07/NACTO_CityLimits_Spreads.pdf#page=7]  Rather than using traffic stops to enforce traffic safety, enhancing urban design (such as through street/sidewalk lighting, marked crosswalks, pedestrian-friendly medians, traffic islands, curb extensions and traffic circles) should be considered as a solution-driven alternative.[https://bridgingthegap.ihrp.uic.edu/_asset/02fpi3/btg_street_walkability_FINAL_03-09-12.pdf] 

### Traffic stops lead to unnecessary, intrusive encounters with LBPD

Instead of creating safer communities, officers use routine traffic stops to profile and harass people of color. Data on traffic and pretextual stops consistently show that stops are ineffective in finding evidence of a crime and disproportionately impact people of color.^[https://www.ppic.org/publication/racial-disparities-in-law-enforcement-stops/] Traffic stops also have little efficacy in preventing or reducing crime. In one case study, when police conducted fewer stops in response to law enforcement scrutiny, there was no observable increase in total, violent, or property crimes.^[https://www.sciencedirect.com/science/article/abs/pii/S0047235217301289]

In Long Beach, LBPD officers use routine traffic stops to search people, but this practice overwhelmingly yields ineffective results. We find most searches, nearly 4 in 5 across all community members, lead to no contraband or evidence found for a crime. In addition to these searches being ineffective generally, they are even more ineffective when applied to people of color. In over 85% of searches done during traffic stops of MESA, Black, Multi-racial, Asian, and AIAN individuals, LBPD officers found no contraband or evidence.

```{r, echo=FALSE}
report_hitrates_race_person <- dbGetQuery(con, "SELECT * FROM data.report_hitrates_race_person") 
#### DS ####
report_hitrates_race_person<-report_hitrates_race_person%>%filter(race!="total")
##### Chart - unfounded searches by race for traffic violations #####

# Apply Chart

fx_barbubblechart(

  db=report_hitrates_race_person, #name of dataframe

  order_var=report_stoprates_race_person$hit_rates, #variable you're sorting by

  x='race_label_short', # x or independent variables

  y='hit_rates', # y or dependent variable

  z='evidence_not_found',

 top_finding=paste0("Most searches LBPD conducts during traffic stops lead to no evidence or contraband found."), # this is the top finding from the chart that gets used like a title


   chart_title= paste0("Searches with No Contraband or Evidence Found among Traffic Stops by Race"), # this is the more standard chart title that gets used as a subtitle


  tooltip_text="For every 100 searches done during traffic stops of people perceived as <b>{point.race_label_long}</b>, LBPD did not find contraband/evidence in <b>{point.hit_rates:.0f}</b> stops,  a total of <b>{point.evidence_not_found:.0f}</b> unnecessary searches.", # customize your tooltip as a statement, calling out rate and count


    chart_caption = paste0(racenote,"<br>", sourcenote, "<br>", "Analysis for all officer-initiated traffic stops where a search occurred."), # if necessary add a method note between the racenote and sourcenote with a line break, use racenote if graph includes data by race, and always use sourcenote. Each of these are standard objects across all charts


 yaxis_label = "''", #format for your y axis labels
  export_data_label=list(pointFormat='{point.hit_rates:.1f}%') # format for your data labels on export images
)


```

# The Solution

# The Takeaway
